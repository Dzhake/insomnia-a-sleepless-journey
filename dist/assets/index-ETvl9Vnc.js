var Ms=Object.defineProperty;var Je=r=>{throw TypeError(r)};var As=(r,t,e)=>t in r?Ms(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var T=(r,t,e)=>As(r,typeof t!="symbol"?t+"":t,e),ke=(r,t,e)=>t.has(r)||Je("Cannot "+e);var n=(r,t,e)=>(ke(r,t,"read from private field"),e?e.call(r):t.get(r)),g=(r,t,e)=>t.has(r)?Je("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(r):t.set(r,e),f=(r,t,e,s)=>(ke(r,t,"write to private field"),s?s.call(r,e):t.set(r,e),e),ft=(r,t,e)=>(ke(r,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const h of i)if(h.type==="childList")for(const a of h.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const h={};return i.integrity&&(h.integrity=i.integrity),i.referrerPolicy&&(h.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?h.credentials="include":i.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(i){if(i.ep)return;i.ep=!0;const h=e(i);fetch(i.href,h)}})();var bs=Object.defineProperty,Is=(r,t)=>{for(var e in t)bs(r,e,{get:t[e],enumerable:!0,configurable:!0,set:s=>t[e]=()=>s})},_s={};Is(_s,{slotTypes:()=>de,permissions:()=>ks,itemsHandlingFlags:()=>cs,itemClassifications:()=>ht,clientStatuses:()=>Le});var Le={disconnected:0,connected:5,ready:10,playing:20,goal:30},ht={progression:1,useful:2,trap:4,none:0},cs={minimal:0,others:1,own:2,starting:4,all:7},ks={disabled:0,enabled:1,goal:2,auto:6,autoEnabled:7},de={spectator:0,player:1,group:2};class It extends Error{}class Cs extends Error{constructor(e,s,i){super(e);T(this,"argumentName");T(this,"value");this.argumentName=s,this.value=structuredClone(i)}}class Ds extends Error{constructor(e,s){super(e);T(this,"errors",[]);this.errors=s}}class at extends Error{}var Ye={timeout:1e4,autoFetchDataPackage:!0,maximumMessages:1e3,debugLogVersions:!0},Rs={major:0,minor:5,build:1},Ns="2.0.4";function Ue(){const r=[];for(let t=0;t<36;t++)r.push(Math.floor(Math.random()*16));return r[14]=4,r[19]=r[19]&=-5,r[19]=r[19]|=8,r[8]=r[13]=r[18]=r[23]="-",r.map(t=>t.toString(16)).join("")}var Ce={password:"",uuid:Ue(),tags:[],version:Rs,items:cs.all,slotData:!0},Ct,tt,Jt,Yt;class bt{constructor(t,e,s,i){g(this,Ct);g(this,tt);g(this,Jt);g(this,Yt);f(this,Ct,t),f(this,tt,e),f(this,Jt,s),f(this,Yt,i)}toString(){return this.name}get receiver(){return n(this,Yt)}get sender(){return n(this,Jt)}get name(){return n(this,Ct).package.lookupItemName(this.game,n(this,tt).item,!0)}get id(){return n(this,tt).item}get locationName(){return n(this,Ct).package.lookupLocationName(this.sender.game,n(this,tt).location,!0)}get locationId(){return n(this,tt).location}get locationGame(){return this.sender.game}get game(){return this.receiver.game}get progression(){return(this.flags&ht.progression)===ht.progression}get useful(){return(this.flags&ht.useful)===ht.useful}get trap(){return(this.flags&ht.trap)===ht.trap}get filler(){return this.flags===ht.none}get flags(){return n(this,tt).flags}}Ct=new WeakMap,tt=new WeakMap,Jt=new WeakMap,Yt=new WeakMap;class Ke{constructor(t,e){T(this,"game");T(this,"checksum");T(this,"itemTable");T(this,"locationTable");T(this,"reverseItemTable");T(this,"reverseLocationTable");this.game=t,this.checksum=e.checksum,this.itemTable=Object.freeze(e.item_name_to_id),this.locationTable=Object.freeze(e.location_name_to_id),this.reverseItemTable=Object.freeze(Object.fromEntries(Object.entries(this.itemTable).map(([s,i])=>[i,s]))),this.reverseLocationTable=Object.freeze(Object.fromEntries(Object.entries(this.locationTable).map(([s,i])=>[i,s])))}exportPackage(){return{checksum:this.checksum,item_name_to_id:{...this.itemTable},location_name_to_id:{...this.locationTable}}}}var Dt,et,wt,yt,we,ps;class Os{constructor(t){g(this,we);g(this,Dt);g(this,et,new Map);g(this,wt,new Map);g(this,yt,new Set);f(this,Dt,t),n(this,Dt).socket.on("roomInfo",e=>{n(this,et).clear(),n(this,wt).clear(),n(this,yt).clear(),n(this,et).set("Archipelago",ft(this,we,ps).call(this));for(const s in e.datapackage_checksums)n(this,wt).set(s,e.datapackage_checksums[s]),n(this,yt).add(s)})}findPackage(t){return n(this,et).get(t)??null}async fetchPackage(t=[],e=!0){t.length===0&&(t=Array.from(n(this,yt))),t=t.filter(i=>{var h;return n(this,yt).has(i)?((h=n(this,et).get(i))==null?void 0:h.checksum)!==n(this,wt).get(i):!1});const s={games:{}};for(const i of t){const h={cmd:"GetDataPackage",games:[i]},[a]=await n(this,Dt).socket.send(h).wait("dataPackage");s.games[i]=a.data.games[i]}return e&&this.importPackage(s),s}importPackage(t){for(const e in t.games)n(this,et).set(e,new Ke(e,t.games[e])),n(this,wt).set(e,t.games[e].checksum)}exportPackage(){return{games:n(this,et).entries().reduce((t,[e,s])=>(t[e]=s.exportPackage(),t),{})}}lookupItemName(t,e,s=!0){const i=`Unknown Item ${e}`,h=this.findPackage(t);if(!h)return s?i:void 0;const a=h.reverseItemTable[e];return s&&a===void 0?i:a}lookupLocationName(t,e,s=!0){const i=`Unknown Location ${e}`,h=this.findPackage(t);if(!h)return s?i:void 0;const a=h.reverseLocationTable[e];return s&&a===void 0?i:a}}Dt=new WeakMap,et=new WeakMap,wt=new WeakMap,yt=new WeakMap,we=new WeakSet,ps=function(){return new Ke("Archipelago",{checksum:"ac9141e9ad0318df2fa27da5f20c50a842afeecb",item_name_to_id:{Nothing:-1},location_name_to_id:{"Cheat Console":-1,Server:-2}})};var Rt,b,Kt,Xt;class Bs{constructor(t,e,s){g(this,Rt);g(this,b,[]);g(this,Kt);g(this,Xt);f(this,Rt,t),f(this,Kt,e),f(this,Xt,s)}replace(t){return n(this,b).push({operation:"replace",value:t}),this}default(){return n(this,b).push({operation:"default",value:null}),this}add(t){return n(this,b).push({operation:"add",value:t}),this}multiply(t){return n(this,b).push({operation:"mul",value:t}),this}power(t){return n(this,b).push({operation:"pow",value:t}),this}remainder(t){return n(this,b).push({operation:"mod",value:t}),this}floor(){return n(this,b).push({operation:"floor",value:null}),this}ceiling(){return n(this,b).push({operation:"ceil",value:null}),this}max(t){return n(this,b).push({operation:"max",value:t}),this}min(t){return n(this,b).push({operation:"min",value:t}),this}and(t){return n(this,b).push({operation:"and",value:t}),this}or(t){return n(this,b).push({operation:"or",value:t}),this}xor(t){return n(this,b).push({operation:"xor",value:t}),this}leftShift(t){return n(this,b).push({operation:"left_shift",value:t}),this}rightShift(t){return n(this,b).push({operation:"right_shift",value:t}),this}remove(t){return n(this,b).push({operation:"remove",value:t}),this}pop(t){return n(this,b).push({operation:"pop",value:t}),this}update(t){return n(this,b).push({operation:"update",value:t}),this}async commit(t=!1){const e=Ue(),s={cmd:"Set",default:n(this,Xt),key:n(this,Kt),operations:n(this,b),want_reply:t,uuid:e};if(n(this,Rt).socket.send(s),!t)return;const[i]=await n(this,Rt).socket.wait("setReply",h=>h.uuid===e);return i.value}}Rt=new WeakMap,b=new WeakMap,Kt=new WeakMap,Xt=new WeakMap;var $,Z,Et,ye,ds;class Fs{constructor(t){g(this,ye);g(this,$);g(this,Z,{});g(this,Et,{});f(this,$,t),n(this,$).socket.on("disconnected",()=>{f(this,Z,{}),f(this,Et,{})}).on("setReply",e=>{n(this,Z)[e.key]=e.value;const s=n(this,Et)[e.key];s&&s.forEach(i=>i(e.key,e.value,e.original_value))}).on("connected",()=>{if(n(this,$).options.debugLogVersions){const e=`${n(this,$).game}:${Ns}:${navigator==null?void 0:navigator.userAgent}`;this.prepare("archipelago.js__runtimes",{}).default().update({[e]:!0}).commit(!1)}})}get store(){return structuredClone(n(this,Z))}async fetch(t,e=!1){let s=typeof t=="string"?[t]:t;if(e){const h=s.filter(a=>n(this,Z)[a]===void 0);h.length>0&&n(this,$).socket.send({cmd:"SetNotify",keys:h})}let i={};if(s=s.filter(h=>{const a=structuredClone(n(this,Z)[h]),o=a!==void 0;return o&&(i[h]=a),!o}),s.length>0){const h=await ft(this,ye,ds).call(this,s);i={...i,...h}}return e&&f(this,Z,{...n(this,Z),...i}),typeof t=="string"?i[t]:i}async notify(t,e){return t.forEach(s=>{var i;(i=n(this,Et))[s]??(i[s]=[]),n(this,Et)[s].push(e)}),this.fetch(t,!0)}prepare(t,e){if(t.startsWith("_read_"))throw TypeError("Cannot manipulate read only keys.");return new Bs(n(this,$),t,e)}async fetchItemNameGroups(t){return await this.fetch([`_read_item_name_groups_${t}`],!0)}async fetchLocationNameGroups(t){return await this.fetch([`_read_location_name_groups_${t}`],!0)}}$=new WeakMap,Z=new WeakMap,Et=new WeakMap,ye=new WeakSet,ds=async function(t){const e=Ue(),[s]=await n(this,$).socket.send({cmd:"Get",keys:t,uuid:e}).wait("retrieved",i=>i.uuid===e);return s.keys};var rt;class vs{constructor(){g(this,rt,{})}addEventListener(t,e,s=!1){var i;(i=n(this,rt))[t]??(i[t]=[]),n(this,rt)[t].push([e,s])}removeEventListener(t,e){const s=n(this,rt)[t];s&&s.length>0&&(n(this,rt)[t]=s.filter(([i])=>i!==e))}dispatchEvent(t,e){const s=n(this,rt)[t]??[];for(const[i,h]of s)i(...e),h&&this.removeEventListener(t,i)}}rt=new WeakMap;var nt;class Gt{constructor(){g(this,nt,new vs)}on(t,e){return n(this,nt).addEventListener(t,e),this}off(t,e){return n(this,nt).removeEventListener(t,e),this}async wait(t,e=()=>!0){return new Promise(s=>{const i=(...h)=>{e(...h)&&(n(this,nt).removeEventListener(t,i),s(h))};n(this,nt).addEventListener(t,i)})}emit(t,e){n(this,nt).dispatchEvent(t,e)}}nt=new WeakMap;var O,St;class Ls extends Gt{constructor(e){super();g(this,O);g(this,St,Number.MIN_SAFE_INTEGER);f(this,O,e),n(this,O).socket.on("bounced",s=>{var i;if((i=s.tags)!=null&&i.includes("DeathLink")&&s.data.time&&s.data.source){const h=s.data;if(h.time===n(this,St))return;f(this,St,h.time),this.emit("deathReceived",[h.source,h.time*1e3,h.cause])}})}get enabled(){return n(this,O).arguments.tags.includes("DeathLink")}enableDeathLink(){n(this,O).arguments.tags.includes("DeathLink")||n(this,O).updateTags([...n(this,O).arguments.tags,"DeathLink"])}disableDeathLink(){n(this,O).arguments.tags.includes("DeathLink")&&n(this,O).updateTags(n(this,O).arguments.tags.filter(e=>e!=="DeathLink"))}sendDeathLink(e,s){if(!n(this,O).authenticated)throw new at("Cannot send death links before connecting and authenticating.");if(!this.enabled)return;f(this,St,Math.ceil(Date.now()/1e3));const i={source:e,cause:s,time:n(this,St)};n(this,O).bounce({tags:["DeathLink"]},i)}}O=new WeakMap,St=new WeakMap;var xt,Nt,qt;class ue{constructor(t,e){g(this,xt);g(this,Nt);g(this,qt);f(this,xt,t),f(this,Nt,e),f(this,qt,new bt(n(this,xt),{item:e.item,location:e.location,player:e.finding_player,flags:e.item_flags},n(this,xt).players.findPlayer(e.finding_player),n(this,xt).players.findPlayer(e.receiving_player)))}get item(){return n(this,qt)}get found(){return n(this,Nt).found}get entrance(){return n(this,Nt).entrance||"Vanilla"}}xt=new WeakMap,Nt=new WeakMap,qt=new WeakMap;var k,ot,L,Ee,us;class Us extends Gt{constructor(e){super();g(this,Ee);g(this,k);g(this,ot,[]);g(this,L,[]);f(this,k,e),n(this,k).socket.on("receivedItems",s=>{let i=s.index;const h=s.items.length,a=[...s.items];for(;a.length>0;){const o=a.shift();n(this,ot)[i++]=new bt(n(this,k),o,n(this,k).players.findPlayer(o.player),n(this,k).players.self)}this.emit("itemsReceived",[n(this,ot).slice(s.index,s.index+h),s.index])}).on("connected",()=>{f(this,L,[]),f(this,ot,[]),n(this,k).storage.notify([`_read_hints_${n(this,k).players.self.team}_${n(this,k).players.self.slot}`],ft(this,Ee,us).bind(this)).then(s=>{const i=s[`_read_hints_${n(this,k).players.self.team}_${n(this,k).players.self.slot}`];f(this,L,i.map(h=>new ue(n(this,k),h))),this.emit("hintsInitialized",[n(this,L)])}).catch(s=>{throw s})})}get received(){return[...n(this,ot)]}get hints(){return[...n(this,L)]}get count(){return n(this,ot).length}}k=new WeakMap,ot=new WeakMap,L=new WeakMap,Ee=new WeakSet,us=function(e,s){for(let i=0;i<s.length;i++)n(this,L)[i]===void 0?(n(this,L)[i]=new ue(n(this,k),s[i]),this.emit("hintReceived",[n(this,L)[i]])):n(this,L)[i].found!==s[i].found&&(n(this,L)[i]=new ue(n(this,k),s[i]),this.emit("hintFound",[n(this,L)[i]]))};class ne{constructor(t,e){T(this,"client");T(this,"part");this.client=t,this.part=e}toString(){return this.text}}class Hs extends ne{constructor(e,s,i,h){super(e,s);T(this,"part");T(this,"type","item");T(this,"item");const a=e.players.findPlayer(s.player,h.team);this.part=s,this.item=new bt(e,i,a,h)}get text(){return this.item.name}}var Ot;class js extends ne{constructor(e,s){super(e,s);g(this,Ot);T(this,"part");T(this,"type","location");T(this,"id");const i=e.players.findPlayer(s.player),h=e.package.findPackage(i.game);this.part=s,s.type==="location_name"?(f(this,Ot,s.text),this.id=h.locationTable[s.text]):(this.id=parseInt(s.text),f(this,Ot,e.package.lookupLocationName(i.game,this.id,!0)))}get text(){return n(this,Ot)}}Ot=new WeakMap;class Gs extends ne{constructor(e,s){super(e,s);T(this,"part");T(this,"type","color");T(this,"color");this.part=s,this.color=s.color}get text(){return this.part.text}}class Ws extends ne{constructor(e,s){super(e,s);T(this,"part");T(this,"type");this.part=s,this.part.type==="entrance_name"?this.type="entrance":this.type="text"}get text(){return this.part.text}}class Vs extends ne{constructor(e,s){super(e,s);T(this,"part");T(this,"type","player");T(this,"player");if(this.part=s,s.type==="player_id")this.player=e.players.findPlayer(parseInt(s.text));else{const i=e.players.teams[e.players.self.team].find(h=>h.name===s.text);if(!i)throw new Error(`Cannot find player under name: ${s.text}`);this.player=i}}get text(){return this.player.alias}}var M,Se,xe,ms;class zs extends Gt{constructor(e){super();g(this,xe);g(this,M);g(this,Se,[]);f(this,M,e),n(this,M).socket.on("printJSON",ft(this,xe,ms).bind(this))}get log(){return[...n(this,Se)]}async say(e){if(!n(this,M).authenticated)throw new at("Cannot send chat messages without being authenticated.");e=e.trim();const s={cmd:"Say",text:e};n(this,M).socket.send(s),await this.wait("chat",i=>i===e)}}M=new WeakMap,Se=new WeakMap,xe=new WeakSet,ms=function(e){const s=[];for(const h of e.data)switch(h.type){case"item_id":case"item_name":{const a=e;let o;a.type==="ItemCheat"?o=n(this,M).players.findPlayer(a.receiving,a.team):o=n(this,M).players.findPlayer(a.receiving),s.push(new Hs(n(this,M),h,a.item,o));break}case"location_id":case"location_name":{s.push(new js(n(this,M),h));break}case"color":{s.push(new Gs(n(this,M),h));break}case"player_id":case"player_name":{s.push(new Vs(n(this,M),h));break}default:{s.push(new Ws(n(this,M),h));break}}const i=s.map(h=>h.text).join();switch(n(this,M).options.maximumMessages>=1&&(this.log.push({text:i,nodes:s}),this.log.splice(0,this.log.length-n(this,M).options.maximumMessages)),e.type){case"ItemSend":{const h=n(this,M).players.findPlayer(e.item.player),a=n(this,M).players.findPlayer(e.receiving),o=new bt(n(this,M),e.item,h,a);this.emit("itemSent",[i,o,s]);break}case"ItemCheat":{const h=n(this,M).players.findPlayer(e.item.player,e.team),a=n(this,M).players.findPlayer(e.receiving,e.team),o=new bt(n(this,M),e.item,h,a);this.emit("itemCheated",[i,o,s]);break}case"Hint":{const h=n(this,M).players.findPlayer(e.item.player),a=n(this,M).players.findPlayer(e.receiving),o=new bt(n(this,M),e.item,h,a);this.emit("itemHinted",[i,o,e.found,s]);break}case"Join":{const h=n(this,M).players.findPlayer(e.slot,e.team);this.emit("connected",[i,h,e.tags,s]);break}case"Part":{const h=n(this,M).players.findPlayer(e.slot,e.team);this.emit("disconnected",[i,h,s]);break}case"Chat":{const h=n(this,M).players.findPlayer(e.slot,e.team);this.emit("chat",[e.message,h,s]);break}case"ServerChat":{this.emit("serverChat",[e.message,s]);break}case"TagsChanged":{const h=n(this,M).players.findPlayer(e.slot,e.team);this.emit("tagsUpdated",[i,h,e.tags,s]);break}case"Tutorial":{this.emit("tutorial",[i,s]);break}case"CommandResult":{this.emit("userCommand",[i,s]);break}case"AdminCommandResult":{this.emit("adminCommand",[i,s]);break}case"Goal":{const h=n(this,M).players.findPlayer(e.slot,e.team);this.emit("goaled",[i,h,s]);break}case"Release":{const h=n(this,M).players.findPlayer(e.slot,e.team);this.emit("released",[i,h,s]);break}case"Collect":{const h=n(this,M).players.findPlayer(e.slot,e.team);this.emit("collected",[i,h,s]);break}case"Countdown":this.emit("countdown",[i,e.countdown,s])}this.emit("message",[i,s])};var U,lt,Bt,me,ls;let oe=(ls=class{constructor(t,e){g(this,Bt);g(this,U);g(this,lt);f(this,U,t),f(this,lt,e)}toString(){return this.alias}get name(){return n(this,lt).name}get alias(){return n(this,lt).alias}get game(){return this.slot===0?"Archipelago":n(this,Bt,me).game}get type(){return this.slot===0?de.spectator:n(this,Bt,me).type}get team(){return n(this,lt).team}get slot(){return n(this,lt).slot}get members(){return this.type!==de.group?[]:n(this,U).players.teams[this.team].filter(t=>n(this,Bt,me).group_members.includes(t.slot))}get groups(){return this.slot===0?[]:n(this,U).players.teams[this.team].filter(t=>t.slot!==0&&n(this,U).players.slots[t.slot].group_members.includes(this.slot))}async fetchStatus(){return this.type===de.group?Le.goal:await n(this,U).storage.fetch(`_read_client_status_${this.team}_${this.slot}`)??0}async fetchSlotData(){return await n(this,U).storage.fetch(`_read_slot_data_${this.slot}`)}async fetchHints(){return(await n(this,U).storage.fetch(`_read_hints_${this.team}_${this.slot}`)).map(e=>new ue(n(this,U),e))}},U=new WeakMap,lt=new WeakMap,Bt=new WeakSet,me=function(){return n(this,U).players.slots[this.slot]},ls);var Q,R,$t,Ft,Zt;class Js extends Gt{constructor(e){super();g(this,Q);g(this,R,[]);g(this,$t,{});g(this,Ft,0);g(this,Zt,0);f(this,Q,e),n(this,Q).socket.on("connected",s=>{var i,h;f(this,$t,Object.freeze(s.slot_info)),f(this,R,[]),f(this,Ft,s.slot),f(this,Zt,s.team);for(const a of s.players)(i=n(this,R))[h=a.team]??(i[h]=[{team:a.team,slot:0,name:"Archipelago",alias:"Archipelago"}]),n(this,R)[a.team][a.slot]=a}).on("roomUpdate",s=>{if(s.players){for(const i of s.players)if(n(this,R)[i.team][i.slot].alias!==i.alias){const h=n(this,R)[i.team][i.slot].alias;n(this,R)[i.team][i.slot]=i,this.emit("aliasUpdated",[new oe(n(this,Q),i),h,i.alias])}}})}get self(){if(n(this,Ft)===0)throw new Error("Cannot lookup own player object when client has never connected to a server.");return new oe(n(this,Q),n(this,R)[n(this,Zt)][n(this,Ft)])}get slots(){return n(this,$t)}get teams(){const e=[];for(let s=0;s<n(this,R).length;s++){e[s]=[];for(let i=0;i<n(this,R)[s].length;i++)e[s].push(new oe(n(this,Q),n(this,R)[s][i]))}return e}findPlayer(e,s){if(s===void 0&&(s=n(this,Q).players.self.team),n(this,R)[s])return new oe(n(this,Q),n(this,R)[s][e])}}Q=new WeakMap,R=new WeakMap,$t=new WeakMap,Ft=new WeakMap,Zt=new WeakMap;var Qt,te,ee,se,ie,he,vt,Pt,Lt,Tt,Mt,At,ct,Pe;class Ys extends Gt{constructor(e){super();g(this,Qt);g(this,te,{major:-1,minor:-1,build:-1});g(this,ee,{major:-1,minor:-1,build:-1});g(this,se,[]);g(this,ie,[]);g(this,he,"");g(this,vt,!1);g(this,Pt,0);g(this,Lt,0);g(this,Tt,0);g(this,Mt,{release:0,collect:0,remaining:0});g(this,At,[]);g(this,ct,[]);g(this,Pe,!1);f(this,Qt,e),n(this,Qt).socket.on("roomInfo",s=>{f(this,te,{major:s.version.major,minor:s.version.minor,build:s.version.build}),f(this,ee,{major:s.generator_version.major,minor:s.generator_version.minor,build:s.generator_version.build}),f(this,ie,s.tags),f(this,se,s.games),f(this,he,s.seed_name),f(this,vt,s.password),f(this,Mt,s.permissions),f(this,Lt,s.hint_cost),f(this,Tt,s.location_check_points)}).on("connected",s=>{f(this,At,s.missing_locations),f(this,ct,s.checked_locations),this.emit("locationsChecked",[this.checkedLocations]),f(this,Pt,s.hint_points),this.emit("hintPointsUpdated",[0,s.hint_points])}).on("roomUpdate",s=>{if(s.hint_cost!==void 0){const[i,h]=[this.hintCost,this.hintCostPercentage];f(this,Lt,s.hint_cost),this.emit("hintCostUpdated",[i,this.hintCost,h,this.hintCostPercentage])}if(s.hint_points!==void 0){const i=n(this,Pt);f(this,Pt,s.hint_points),this.emit("hintPointsUpdated",[i,this.hintPoints])}if(s.location_check_points!==void 0){const i=n(this,Tt);f(this,Tt,s.location_check_points),this.emit("locationCheckPointsUpdated",[i,this.locationCheckPoints])}if(s.password!==void 0&&(f(this,vt,s.password),this.emit("passwordUpdated",[this.password])),s.permissions!==void 0){const i=n(this,Mt);f(this,Mt,s.permissions),this.emit("permissionsUpdated",[i,this.permissions])}s.checked_locations!==void 0&&(f(this,ct,[...n(this,ct),...s.checked_locations]),f(this,At,this.missingLocations.filter(i=>{var h;return!((h=s.checked_locations)!=null&&h.includes(i))})),this.emit("locationsChecked",[s.checked_locations]))})}get serverVersion(){return{...n(this,te)}}get generatorVersion(){return{...n(this,ee)}}get games(){return[...n(this,se)]}get tags(){return[...n(this,ie)]}get seedName(){return n(this,he)}get password(){return n(this,vt)}get permissions(){return{...n(this,Mt)}}get hintPoints(){return n(this,Pt)}get hintCost(){return this.hintCostPercentage>0?Math.max(1,Math.floor(this.hintCostPercentage*this.allLocations.length*.01)):0}get hintCostPercentage(){return n(this,Lt)}get locationCheckPoints(){return n(this,Tt)}get missingLocations(){return[...n(this,At)].sort()}get checkedLocations(){return[...n(this,ct)].sort()}get allLocations(){return[...n(this,At),...n(this,ct)].sort()}get race(){return n(this,Pe)}}Qt=new WeakMap,te=new WeakMap,ee=new WeakMap,se=new WeakMap,ie=new WeakMap,he=new WeakMap,vt=new WeakMap,Pt=new WeakMap,Lt=new WeakMap,Tt=new WeakMap,Mt=new WeakMap,At=new WeakMap,ct=new WeakMap,Pe=new WeakMap;var C,Ut,jt,fs,gs;class Ks extends Gt{constructor(){super();g(this,jt);g(this,C,null);g(this,Ut,!1)}get connected(){return n(this,Ut)}get url(){var e;return((e=n(this,C))==null?void 0:e.url)??""}send(...e){if(n(this,C))return n(this,C).send(JSON.stringify(e)),this.emit("sentPackets",[e]),this;throw new It("Unable to send packets to the server; not connected to a server.")}async connect(e){if(this.disconnect(),typeof e=="string"){if(!/^([a-zA-Z]+:)\/\/[A-Za-z0-9_.~\-:]+/i.test(e))try{return await this.connect(new URL(`wss://${e}`))}catch{return await this.connect(new URL(`ws://${e}`))}e=new URL(e)}if(e.port=e.port||"38281",e.protocol!=="wss:"&&e.protocol!=="ws:")throw new TypeError("Unexpected protocol. Archipelago only supports the ws:// and wss:// protocols.");try{return new Promise((s,i)=>{const h=ft(this,jt,gs).call(this);if(h===null)throw new It("Unable to find a suitable WebSocket API in the current runtime.");f(this,C,new h(e)),n(this,C).onmessage=ft(this,jt,fs).bind(this),n(this,C).onclose=()=>{this.disconnect(),i(new It("Failed to connect to Archipelago server."))},n(this,C).onerror=()=>{this.disconnect(),i(new It("Failed to connect to Archipelago server."))},n(this,C).onopen=()=>{this.wait("roomInfo").then(([a])=>{if(f(this,Ut,!0),n(this,C)){n(this,C).onclose=this.disconnect.bind(this),n(this,C).onerror=this.disconnect.bind(this),s(a);return}this.disconnect(),i(new It("Failed to connect to Archipelago server."))}).catch(a=>{throw a})}})}catch(s){throw this.disconnect(),s}}disconnect(){var e;this.connected&&(f(this,Ut,!1),(e=n(this,C))==null||e.close(),f(this,C,null),this.emit("disconnected",[]))}}C=new WeakMap,Ut=new WeakMap,jt=new WeakSet,fs=function(e){const s=JSON.parse(e.data);for(const i of s){switch(i.cmd){case"ConnectionRefused":this.emit("connectionRefused",[i]);break;case"Bounced":this.emit("bounced",[i,i.data]);break;case"Connected":this.emit("connected",[i]);break;case"DataPackage":this.emit("dataPackage",[i]);break;case"InvalidPacket":this.emit("invalidPacket",[i]);break;case"LocationInfo":this.emit("locationInfo",[i]);break;case"PrintJSON":this.emit("printJSON",[i]);break;case"ReceivedItems":this.emit("receivedItems",[i]);break;case"Retrieved":this.emit("retrieved",[i]);break;case"RoomInfo":this.emit("roomInfo",[i]);break;case"RoomUpdate":this.emit("roomUpdate",[i]);break;case"SetReply":this.emit("setReply",[i]);break}this.emit("receivedPacket",[i])}},gs=function(){let e=null;return typeof window<"u"?e=window.WebSocket||window.MozWebSocket:typeof global<"u"?e=global.WebSocket||global.MozWebSocket:typeof self<"u"?e=self.WebSocket||self.MozWebSocket:typeof WebSocket<"u"?e=WebSocket:typeof MozWebSocket<"u"&&(e=MozWebSocket),e};var Ht,st,ae,re;class Xs{constructor(t){g(this,Ht,!1);g(this,st,Ce);g(this,ae,"");g(this,re,"");T(this,"socket",new Ks);T(this,"package",new Os(this));T(this,"storage",new Fs(this));T(this,"room",new Ys(this));T(this,"players",new Js(this));T(this,"items",new Us(this));T(this,"messages",new zs(this));T(this,"deathLink",new Ls(this));T(this,"options");t?this.options={...Ye,...t}:this.options={...Ye},this.socket.on("disconnected",()=>{f(this,Ht,!1)}).on("sentPackets",e=>{for(const s of e)s.cmd==="ConnectUpdate"&&(n(this,st).tags=s.tags,n(this,st).items=s.items_handling)})}get authenticated(){return this.socket.connected&&n(this,Ht)}get name(){return n(this,ae)}get game(){return n(this,re)}get arguments(){return{...n(this,st)}}async login(t,e,s="",i){if(e==="")throw new Cs("Provided slot name cannot be blank.","name",e);i?f(this,st,{...Ce,...i}):f(this,st,{...Ce});const h=new Set(this.arguments.tags);!s&&!h.has("HintGame")&&!h.has("Tracker")&&!h.has("TextOnly")&&h.add("TextOnly"),n(this,st).tags=Array.from(h);const a={cmd:"Connect",name:e,game:s,password:this.arguments.password,slot_data:this.arguments.slotData,items_handling:this.arguments.items,uuid:this.arguments.uuid,tags:this.arguments.tags,version:{...this.arguments.version,class:"Version"}};return await this.socket.connect(t),this.options.autoFetchDataPackage&&await this.package.fetchPackage(),new Promise((o,l)=>{const p=setTimeout(()=>l(new It("Server failed to respond in time.")),this.options.timeout),d=m=>{f(this,Ht,!0),f(this,re,m.slot_info[m.slot].game),f(this,ae,m.slot_info[m.slot].name),this.socket.off("connected",d).off("connectionRefused",u),clearTimeout(p),o(m.slot_data)},u=m=>{var y;this.socket.off("connected",d).off("connectionRefused",u),clearTimeout(p),l(new Ds(`Connection was refused by the server. Reason(s): [${(y=m.errors)==null?void 0:y.join(", ")}`,m.errors??[]))};this.socket.on("connected",d.bind(this)).on("connectionRefused",u.bind(this)).send(a)})}updateStatus(t){if(!this.authenticated)throw new at("Cannot update status while not connected and authenticated.");this.socket.send({cmd:"StatusUpdate",status:t})}goal(){this.updateStatus(Le.goal)}updateTags(t){if(!this.authenticated)throw new at("Cannot update tags while not connected and authenticated.");this.socket.send({cmd:"ConnectUpdate",tags:t,items_handling:this.arguments.items})}updateItemsHandling(t){if(!this.authenticated)throw new at("Cannot update tags while not connected and authenticated.");this.socket.send({cmd:"ConnectUpdate",tags:this.arguments.tags,items_handling:t})}check(...t){if(!this.authenticated)throw new at("Cannot check locations while not connected and authenticated.");t=t.filter(e=>this.room.missingLocations.includes(e)),this.socket.send({cmd:"LocationChecks",locations:t})}async scout(t,e=0){if(!this.authenticated)throw new at("Cannot scout locations while not connected and authenticated.");t=t.filter(i=>this.room.allLocations.includes(i));const[s]=await this.socket.send({cmd:"LocationScouts",create_as_hint:e,locations:t}).wait("locationInfo",i=>i.locations.map(h=>h.location).toSorted().join(",")===t.toSorted().join(","));return s.locations.map(i=>new bt(this,i,this.players.self,this.players.findPlayer(i.player)))}bounce(t,e){if(!this.authenticated)throw new at("Cannot send bounces while not connected and authenticated.");this.socket.send({cmd:"Bounce",data:e,games:t.games??[],slots:t.slots??[],tags:t.tags??[]})}}Ht=new WeakMap,st=new WeakMap,ae=new WeakMap,re=new WeakMap;const V=(r,t)=>(r|=0,t|=0,(r%t+t)%t),ut=(r,t,e)=>Math.max(t,Math.min(r,e)),I=class I{constructor(t=0,e=0){this.length=()=>Math.hypot(this.x,this.y),this.clone=()=>new I(this.x,this.y),this.toVector3XZ=s=>new Ne(this.x,s.y,this.y),this.x=t,this.y=e}normalize(t=!1){let s=this.length();return s<1e-4?(this.x=t?1:0,this.y=0,this.clone()):(this.x/=s,this.y/=s,this.clone())}zeros(){this.x=0,this.y=0}scalarMultiply(t){this.x*=t,this.y*=t}static max(t,e){let s=t.clone();return s.length()>e&&s.normalize(),s}};I.dot=(t,e)=>t.x*e.x+t.y*e.y,I.normalize=(t,e=!1)=>t.clone().normalize(e),I.scalarMultiply=(t,e)=>new I(t.x*e,t.y*e),I.distance=(t,e)=>Math.hypot(t.x-e.x,t.y-e.y),I.direction=(t,e)=>new I(e.x-t.x,e.y-t.y).normalize(!0),I.add=(t,e)=>new I(t.x+e.x,t.y+e.y),I.project=(t,e)=>I.scalarMultiply(e,I.dot(t,e)),I.lerp=(t,e,s)=>new I((1-s)*t.x+s*e.x,(1-s)*t.y+s*e.y);let c=I;const _=class _{constructor(t=0,e=0,s=0){this.length=()=>Math.hypot(this.x,this.y,this.z),this.clone=()=>new _(this.x,this.y,this.z),this.toVector2XZ=()=>new c(this.x,this.z),this.x=t,this.y=e,this.z=s}normalize(t=!1){let s=this.length();return s<1e-4?(this.x=t?1:0,this.y=0,this.z=0,this.clone()):(this.x/=s,this.y/=s,this.z/=s,this.clone())}zeros(){this.x=0,this.y=0,this.z=0}scalarMultiply(t){this.x*=t,this.y*=t,this.z*=t}};_.dot=(t,e)=>t.x*e.x+t.y*e.y+t.z*e.z,_.normalize=(t,e=!1)=>t.clone().normalize(e),_.scalarMultiply=(t,e)=>new _(t.x*e,t.y*e,t.z*e),_.distance=(t,e)=>Math.hypot(t.x-e.x,t.y-e.y,t.z-e.z),_.direction=(t,e)=>new _(e.x-t.x,e.y-t.y,e.z-t.z).normalize(!0),_.add=(t,e)=>new _(t.x+e.x,t.y+e.y,t.z+e.z),_.cross=(t,e)=>new _(t.y*e.z-t.z*e.y,-(t.x*e.z-t.z*e.x),t.x*e.y-t.y*e.x),_.lerp=(t,e,s)=>new _((1-s)*t.x+s*e.x,(1-s)*t.y+s*e.y,(1-s)*t.z+s*e.z);let Ne=_;class He{constructor(t=0,e=0,s=0,i=0){this.clone=()=>new He(this.x,this.y,this.w,this.h),this.x=t,this.y=e,this.w=s,this.h=i}isEqualToOpposite(t){return t==null?!1:Math.abs(t.x-this.w)<1e-4&&Math.abs(t.y-this.h)<1e-4&&Math.abs(t.w-this.x)<1e-4&&Math.abs(t.h-this.y)<1e-4}}var S=(r=>(r[r.None=0]="None",r[r.Horizontal=1]="Horizontal",r[r.Vertical=2]="Vertical",r[r.Both=3]="Both",r))(S||{});const Xe=(r,t,e,s=1)=>"rgba("+String(r|0)+","+String(t|0)+","+String(e|0)+","+String(ut(s,0,1)),qs=()=>document.getElementById("cdiv"),qe=(r,t,e,s=!0)=>{let i=document.createElement("canvas");return i.width=t,i.height=e,r!=null&&r.appendChild(i),i};class $s{constructor(t,e,s){this.isShaking=()=>this.shakeTimer>0,this.width=t,this.height=e,this.assets=s,this.translation=new c,this.canvasDiv=qs(),this.canvas=qe(this.canvasDiv,t,e),this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.canvasCopyBuffer=qe(null,t*3,e,!1),this.canvasCopyBuffer.getContext("2d").imageSmoothingEnabled=!1,window.addEventListener("resize",()=>this.resize(window.innerWidth,window.innerHeight)),this.resize(window.innerWidth,window.innerHeight),this.shakeTimer=0,this.shakeMagnitude=0}resize(t,e){let s=this.canvas,i=Math.min(t/s.width,e/s.height);i>=1&&(i=Math.floor(i));let h=s.width*i,a=s.height*i,o=t/2-h/2,l=e/2-a/2,p=String(l|0)+"px",d=String(o|0)+"px";s.style.width=String(h|0)+"px",s.style.height=String(a|0)+"px",s.style.top=p,s.style.left=d}moveTo(t=0,e=0){this.translation.x=t|0,this.translation.y=e|0}move(t,e){this.translation.x+=t|0,this.translation.y+=e|0}clear(t=0,e=0,s=0){this.ctx.fillStyle=Xe(t,e,s),this.ctx.fillRect(0,0,this.width,this.height)}setFillColor(t=0,e=t,s=e,i=1){let h=Xe(t,e,s,i);this.ctx.fillStyle=h}setGlobalAlpha(t=1){this.ctx.globalAlpha=ut(t,0,1)}fillRect(t=0,e=0,s=this.width,i=this.height){t+=this.translation.x,e+=this.translation.y,this.ctx.fillRect(t|0,e|0,s|0,i|0)}drawBitmap(t,e,s,i=0){this.drawBitmapRegion(t,0,0,t.width,t.height,e,s,i)}drawBitmapRegion(t,e,s,i,h,a,o,l=0){if(t==null||i<=0||h<=0)return;let p=this.ctx;a+=this.translation.x,o+=this.translation.y,e|=0,s|=0,i|=0,h|=0,a|=0,o|=0,l=l|0,l!=0&&p.save(),(l&1)!=0&&(p.translate(i,0),p.scale(-1,1),a*=-1),(l&2)!=0&&(p.translate(0,h),p.scale(1,-1),o*=-1),p.drawImage(t,e,s,i,h,a,o,i,h),l!=0&&p.restore()}drawText(t,e,s,i,h=0,a=0,o=!1){let l=t.width/16|0,p=l,d=s,u=i,m;o&&(s-=e.length*(l+h)/2,d=s);for(let y=0;y<e.length;++y){if(m=e.charCodeAt(y),m==10){d=s,u+=p+a;continue}this.drawBitmapRegion(t,m%16*l,(m/16|0)*p,l,p,d,u),d+=l+h}}fillCircle(t,e,s){if(t<=0)return;e+=this.translation.x,s+=this.translation.y;let i,h;for(let a=s-t;a<s+t;++a)i=a-s,h=(Math.sqrt(t*t-i*i)|0)*2,this.ctx.fillRect(e-h/2|0,a|0,h|0,1)}fillCircleOutside(t,e,s){let i=this.ctx;if(t<=0){i.fillRect(0,0,this.width,this.height);return}else if(t*t>=this.width*this.width+this.height*this.height)return;e==null&&(e=this.width/2),s==null&&(s=this.height/2);let h=Math.max(0,s-t)|0,a=Math.min(this.height,s+t)|0;h>0&&i.fillRect(0,0,this.width,h),a<this.height&&i.fillRect(0,a,this.width,this.height-a);let o,l,p;for(let d=h;d<a;++d){if(o=d-s,Math.abs(o)>=t){i.fillRect(0,d|0,this.width|0,1);continue}l=Math.round(e-Math.sqrt(t*t-o*o)),p=Math.round(e+Math.sqrt(t*t-o*o)),l>0&&i.fillRect(0,d|0,l|0,1),p<this.width&&i.fillRect(p|0,d|0,this.width-l|0,1)}}drawSpriteFrame(t,e,s,i,h,a,o=0){t.drawFrame(this,e,s,i,h,a,o)}drawSprite(t,e,s,i,h=0){t.draw(this,e,s,i,h)}drawPixelatedLine(t,e,s,i){t|=0,e|=0,s|=0,i|=0;let h=Math.abs(s-t),a=t<s?1:-1,o=Math.abs(i-e),l=e<i?1:-1,p=(h>o?h:-o)/2,d;for(;this.ctx.fillRect(t|0,e|0,1,1),!(t==s&&e==i);)d=p,d>-h&&(p-=o,t+=a),d<o&&(p+=h,e+=l)}update(t){this.shakeTimer>0&&(this.shakeTimer-=t.step)}applyShake(){if(this.shakeTimer<=0)return;let t=Math.round(Math.random()*(this.shakeMagnitude*2)-this.shakeMagnitude),e=Math.round(Math.random()*(this.shakeMagnitude*2)-this.shakeMagnitude);this.move(t,e)}shake(t,e){this.shakeTimer=t,this.shakeMagnitude=e}copyCanvasToBuffer(){let t=this.canvasCopyBuffer.getContext("2d");for(let e=0;e<3;++e)t.drawImage(this.canvas,e*this.canvas.width,0)}fillScreenWithWavingCenteredImage(t,e,s,i){t==null&&(t=this.canvasCopyBuffer);let h,a=-t.width/3;for(let o=0;o<this.height;++o)h=Math.round(Math.sin((o/t.height*s+i)*Math.PI*2)*e*i),this.drawBitmapRegion(t,0,o,t.width,1,a-h,o)}}class A{constructor(t,e){this.getRow=()=>this.row,this.getColumn=()=>this.column,this.getTimer=()=>this.timer,this.width=t,this.height=e,this.row=0,this.column=0,this.timer=0}animate(t,e,s,i,h=1){if(t|=0,e|=0,s|=0,i|=0,e==s){this.timer=0,this.column=e,this.row=t;return}this.row!=t&&(this.timer=0,this.column=s>e?e:s,this.row=t),(e<s&&this.column<e||e>s&&this.column>e)&&(this.column=e),this.timer+=h,this.timer>i&&(e<s?++this.column>s&&(this.column=e):--this.column<s&&(this.column=e),this.timer-=i)}setFrame(t,e,s=!1){this.column=t,this.row=e,s||(this.timer=0)}drawFrame(t,e,s,i,h,a,o=S.None){t.drawBitmapRegion(e,this.width*s,this.height*i,this.width,this.height,h,a,o)}draw(t,e,s,i,h=S.None){this.drawFrame(t,e,this.column,this.row,s,i,h)}}const $e=(r,t,e)=>r<t?Math.min(t,r+e):Math.max(t,r-e),W=(r,t,e,s,i,h,a)=>{let o=r.x+t.x-e.x/2,l=r.y+t.y-e.y/2;return o+e.x>=s&&o<s+h&&l+e.y>=i&&l<i+a};class ws{constructor(t=!0){this.doesExist=()=>this.exist,this.exist=t}kill(){this.exist=!1}}function Te(r,t){let e;e=null;for(let s of r)if(!s.doesExist()){e=s;break}return e==null&&(e=new t.prototype.constructor,r.push(e)),e}class Me extends ws{constructor(t,e,s=!0){super(s),this.overlayObject=i=>W(this.pos,this.center,this.hitbox,i.pos.x+i.center.x-i.hitbox.x/2,i.pos.y+i.center.y-i.hitbox.y/2,i.hitbox.x,i.hitbox.y),this.overlayObjectSpecialHitbox=(i,h,a)=>W(this.pos,this.center,this.hitbox,i.pos.x+h.x-a.x/2,i.pos.y+h.y-a.y/2,a.x,a.y),this.getPos=()=>this.pos.clone(),this.getHitbox=()=>this.hitbox.clone(),this.isInCamera=()=>this.inCamera,this.isDying=()=>this.dying,this.pos=new c(t,e),this.oldPos=this.pos.clone(),this.center=new c,this.hitbox=new c,this.dying=!1,this.inCamera=!1,this.offCameraRadius=0,this.spr=new A(0,0)}die(t){return!0}updateLogic(t){}outsideCameraEvent(){}update(t){if(!(!this.exist||!this.inCamera)){if(this.dying){this.die(t)&&(this.exist=!1,this.dying=!1);return}this.oldPos=this.pos.clone(),this.updateLogic(t)}}cameraCheck(t){let e=t.getPosition(),s=new c(this.spr.width+this.offCameraRadius*2,this.spr.height+this.offCameraRadius*2),i=this.inCamera;this.inCamera=W(this.pos,this.center,s,e.x,e.y,t.width,t.height),i&&!this.inCamera&&this.outsideCameraEvent()}forceKill(){this.exist=!1,this.dying=!1}draw(t){}postDraw(t){}}class ys extends Me{constructor(t,e,s=!0){super(t,e,s),this.getSpeed=()=>this.speed.clone(),this.getTarget=()=>this.target.clone(),this.speed=new c,this.target=this.speed.clone(),this.friction=new c(1,1)}preMovementEvent(t){}postMovementEvent(t){}updateMovement(t){this.speed.x=$e(this.speed.x,this.target.x,this.friction.x*t.step),this.speed.y=$e(this.speed.y,this.target.y,this.friction.y*t.step),this.pos.x+=this.speed.x*t.step,this.pos.y+=this.speed.y*t.step}updateLogic(t){this.preMovementEvent(t),this.updateMovement(t),this.postMovementEvent(t)}stopMovement(){this.speed.zeros(),this.target.zeros()}}class je extends ys{constructor(t,e,s=!0){super(t,e,s),this.getCollisionBox=()=>this.collisionBox.clone(),this.doesIgnoreFenceCollisions=()=>this.ignoreFenceCollisions,this.doesTakeCameraBorderCollision=()=>this.takeCameraBorderCollision,this.collisionBox=new c,this.disableCollisions=!1,this.ignoreFenceCollisions=!1,this.takeCameraBorderCollision=!0}wallCollisionEvent(t,e){}verticalCollisionEvent(t,e){}wallCollision(t,e,s,i,h,a=!1){if(!this.inCamera||!a&&this.disableCollisions||!this.exist||this.dying||this.speed.x*i<.001)return!1;let u=this.pos.y+this.center.y-this.collisionBox.y/2;if(u+this.collisionBox.y<=e+1||u>=e+s-1)return!1;let y=this.center.x+this.collisionBox.x/2*i,P=this.oldPos.x+y,w=this.pos.x+y;return i>0&&w>=t-1*h.step&&P<=t+(4+this.speed.x)*h.step||i<0&&w<=t+1*h.step&&P>=t-(4-this.speed.x)*h.step?(this.pos.x=t-y,this.speed.x=0,this.wallCollisionEvent(i,h),!0):!1}verticalCollision(t,e,s,i,h,a=!1){if(!this.inCamera||!a&&this.disableCollisions||!this.exist||this.dying||this.speed.y*i<.001||this.pos.x+this.collisionBox.x/2<t+1||this.pos.x-this.collisionBox.x/2>=t+s-1)return!1;let u=this.pos.y+this.center.y+i*this.collisionBox.y/2;return i>0&&u>e-1*h.step&&u<=e+(this.speed.y+4)*h.step||i<0&&u<e+1*h.step&&u>=e+(this.speed.y-4)*h.step?(this.pos.y=e-this.center.y-i*this.collisionBox.y/2,this.speed.y=0,this.verticalCollisionEvent(i,h),!0):!1}hurtCollision(t,e,s,i,h,a){return!1}ladderCollision(t,e,s,i,h,a){return!1}breakCollision(t,e,s,i,h,a){return!1}windCollision(t,e,s,i,h){return!1}waterCollision(t,e,s,i,h,a){return!1}}class Zs extends ws{constructor(){super(),this.pos=new c,this.animSpeed=0,this.spr=new A(8,8),this.speed=new c,this.exist=!1}spawn(t,e,s,i=new c,h=0){this.pos=new c(t,e),this.animSpeed=s,this.speed=i.clone(),this.spr.setFrame(0,h),this.exist=!0}update(t){this.exist&&(this.pos.x+=this.speed.x*t.step,this.pos.y+=this.speed.y*t.step,this.spr.animate(this.spr.getRow(),0,4,this.animSpeed,t.step),this.spr.getColumn()==4&&(this.exist=!1))}draw(t){if(!this.exist)return;let e=Math.round(this.pos.x-4)|0,s=Math.round(this.pos.y-4)|0;t.drawSprite(this.spr,t.assets.getBitmap("dust"),e,s)}kill(){this.exist=!1}}var E=(r=>(r[r.Up=0]="Up",r[r.Released=2]="Released",r[r.Down=1]="Down",r[r.Pressed=3]="Pressed",r[r.DownOrPressed=1]="DownOrPressed",r))(E||{});class pt{constructor(t,e){this.key=t,this.value=e}}const Ze=2,Qe=3;class F extends je{constructor(t,e,s,i,h=!1,a=!1){super(t,e+1),this.touchGround=()=>this.canJump&&!this.downAttacking&&this.downAttackWaitTimer<=0&&!this.throwing&&!this.sliding&&!this.climbing&&this.knockbackTimer<=0,this.checkSpinOverlay=o=>this.spinning&&o.overlayObjectSpecialHitbox(this,new c(0,-this.spinHitbox.y/2),this.spinHitbox),this.isInside=()=>this.inside,this.maxHealth=()=>this.progress.doesValueExistInArray("items",9)?4:3,this.getHealth=()=>this.health,this.isDownAttacking=()=>this.downAttacking,this.isSpinning=()=>this.spinning,this.getActiveCheckpointReference=()=>this.activeCheckpoint,this.resetActiveCheckpointReference=()=>this.activeCheckpoint=null,this.isSwimming=()=>this.touchWater,this.sprSpin=new A(32,16),this.startPos=this.pos.clone(),this.spr=new A(16,16),this.spr.setFrame(5,1),this.hitbox=new c(9,11),this.center=new c(0,2),this.collisionBox=new c(8,12),this.friction=new c(.1,.15),this.offCameraRadius=0,this.jumpTimer=0,this.jumpMargin=0,this.canJump=!0,this.jumpSpeed=0,this.doubleJump=!1,this.jumpReleased=!1,this.touchWater=!1,this.faceDir=1,this.flip=a?S.Horizontal:S.None,this.inCamera=!0,this.dust=new Array,this.dustTimer=0,this.climbX=0,this.climbing=!1,this.touchLadder=!1,this.isLadderTop=!1,this.throwing=!1,this.canThrow=!1,this.climbFrame=0,this.sliding=!1,this.slideTimer=0,this.spinCount=0,this.spinning=!1,this.canSpin=!1,this.spinHitbox=new c(28,6),this.downAttackWaitTimer=0,this.downAttacking=!1,this.invulnerabilityTimer=0,this.knockbackTimer=0,this.flapping=!1,this.showActionSymbol=!1,this.actionSymbolId=0,this.sprActionSymbol=new A(16,16),this.holdingItem=!1,this.itemID=0,this.inside=h,this.startInside=h,this.hasTeleported=!1,this.health=3,this.deathTimer=0,this.activeCheckpoint=null,this.projectileCb=s,this.progress=i,this.isInFinalArea=a}static getInstance(){return F.instance||(F.instance=new F),F.instance}startClimbing(t){!this.climbing&&this.touchLadder&&(!this.isLadderTop&&t.input.upPress()||this.isLadderTop&&t.input.downPress())&&(this.climbing=!0,this.jumpTimer=0,this.doubleJump=!1,this.flapping=!1,this.canSpin=!0,this.spinning=!1,this.pos.x=this.climbX,this.isLadderTop&&(this.pos.y+=6),this.stopMovement(),this.jumpTimer=0)}climb(t){this.target.x=0;let h=t.input.getStick().x;Math.abs(h)>.1&&(this.faceDir=h>0?1:-1),this.flip=S.None;let a=t.input.getAction("fire1");this.touchLadder?(this.canThrow=!0,this.target.y=.5*t.input.getStick().y,a==E.Pressed&&(this.climbing=!1,this.doubleJump=!1,this.jumpReleased=!1,t.input.getStick().y<.1&&(this.jumpTimer=10),Math.abs(h)>.1&&(this.faceDir=h>0?1:-1),t.audio.playSample(t.assets.getSample("jump"),.5))):this.climbing=!1}throwRock(t){return this.progress.doesValueExistInArray("items",3)?this.throwing?!0:!this.sliding&&this.canThrow&&t.input.getAction("fire4")==E.Pressed?(this.throwing=!0,this.canThrow=!1,this.flip=this.faceDir>0?S.None:S.Horizontal,this.climbing&&(this.climbFrame=this.spr.getColumn()),this.spr.setFrame(0,3),this.stopMovement(),this.jumpTimer=0,this.projectileCb(this.pos.x+this.faceDir*6,this.pos.y-2,this.faceDir*3,-1,!0,0,!0),t.audio.playSample(t.assets.getSample("throw"),.6),!0):!1:!1}computeCollisionBoxHeight(){this.collisionBox.y=this.sliding?2:10,this.center.y=this.sliding?6:2}slide(t){if(!this.progress.doesValueExistInArray("items",4))return!1;let i=t.input.getAction("fire3");return this.sliding?(this.slideTimer-=t.step)<=0||(i&E.DownOrPressed)==0?(this.sliding=!1,!1):!0:this.canJump&&i==E.Pressed?(this.slideTimer=20,this.target.x=0,this.speed.x=3*this.faceDir,this.dustTimer=0,this.sliding=!0,this.computeCollisionBoxHeight(),t.audio.playSample(t.assets.getSample("jump"),.5),!0):!1}waitDownAttack(t){return this.downAttackWaitTimer>0?(this.downAttackWaitTimer-=t.step,this.downAttackWaitTimer>0):this.downAttacking}jump(t){let p=t.input.getAction("fire1");if(this.progress.doesValueExistInArray("items",1)&&!this.canJump&&!this.spinning&&t.input.getStick().y>.25&&p==E.Pressed){this.downAttacking=!0,this.downAttackWaitTimer=0,this.stopMovement(),this.speed.y=-1.5,this.target.y=6,t.audio.playSample(t.assets.getSample("dive"),.55);return}this.jumpTimer<=0&&(this.jumpMargin>0||!this.doubleJump&&this.progress.doesValueExistInArray("items",6))&&p==E.Pressed?(this.jumpMargin>0?(this.jumpSpeed=Ze+Math.abs(this.speed.x)*.25,this.jumpMargin=0,this.jumpTimer=12,t.audio.playSample(t.assets.getSample("jump"),.5)):(this.jumpTimer=30,this.jumpSpeed=Ze,this.doubleJump=!0),this.canJump=!1,this.jumpReleased=!1):this.jumpTimer>0&&(p&E.DownOrPressed)==0&&(this.jumpTimer=0),!this.flapping&&!this.jumpReleased&&(p&E.DownOrPressed)==0&&(this.jumpReleased=!0),this.flapping=!this.touchWater&&!this.canJump&&!this.spinning&&this.progress.doesValueExistInArray("items",5)&&this.jumpReleased&&this.jumpTimer<=0&&(!this.progress.doesValueExistInArray("items",6)||this.doubleJump)&&(p&E.DownOrPressed)==1,this.flapping&&(this.target.y=.5,this.speed.y>this.target.y&&(this.speed.y=this.target.y))}spin(t){if(this.climbing||this.throwing||this.downAttacking||this.downAttackWaitTimer>0)return!1;if(this.spinning)return!0;let e=t.input.getAction("fire2");return!this.spinning&&this.canSpin&&e==E.Pressed?(this.spinning=!0,this.spinCount=0,this.canSpin=!1,this.flapping=!1,this.sprSpin.setFrame(0,0),t.audio.playSample(t.assets.getSample("spin"),.5),!0):!1}control(t){let p=t.input.getStick();if(this.computeCollisionBoxHeight(),this.friction.y=this.downAttacking?.3:.15,!(!this.spin(t)&&(this.waitDownAttack(t)||this.throwRock(t)||this.slide(t)))){if(this.startClimbing(t),this.climbing){this.climb(t);return}this.target.x=p.x*.75,this.target.y=Qe,Math.abs(p.x)>.01&&(this.flip=p.x>0?S.None:S.Horizontal,this.faceDir=p.x>0?1:-1),this.jump(t),this.running=this.progress.doesValueExistInArray("items",0)&&Math.abs(this.target.x)>.01,this.running&&(this.target.x*=1.66667),this.touchWater&&(this.target.x*=.5,this.target.y*=.25,this.friction.y*=.25,this.speed.y>this.target.y+.01&&(this.speed.y=this.target.y))}}animate(t){let m,y,P;this.sprActionSymbol.animate(this.actionSymbolId,0,1,16,t.step);let w=this.sprSpin.getColumn(),x=t.input.getAction("fire2");if(!(this.spinning&&(this.sprSpin.animate(0,0,7,2,t.step),w>this.sprSpin.getColumn()&&(++this.spinCount>=2||(x&E.DownOrPressed)==0?(this.spinning=!1,this.spinCount=0):x==E.Down&&t.audio.playSample(t.assets.getSample("spin"),.5)),this.spinning))){if(this.downAttacking){this.spr.animate(5,0,3,4,t.step);return}else if(this.downAttackWaitTimer>0){this.spr.setFrame(0,5);return}if(this.sliding){this.spr.setFrame(0,1);return}if(this.throwing)if(this.spr.animate(3,0,2,this.spr.getColumn()==1?12:6,t.step),this.spr.getColumn()==2)this.climbing?this.spr.setFrame(this.climbFrame,2):this.spr.setFrame(0,0),this.throwing=!1;else return;if(this.climbing){w=this.spr.getColumn(),Math.abs(this.speed.y)>.01&&this.spr.animate(2,3,4,10,t.step),w!=this.spr.getColumn()&&w!=3&&t.audio.playSample(t.assets.getSample("climb"),.7);return}if(this.touchWater){P=this.jumpTimer>0?6:5,(this.jumpTimer>0||Math.abs(this.target.x)>.01||this.jumpTimer<=0&&this.spr.getRow()==6||this.spr.getRow()<5||this.spr.getRow()>6)&&this.spr.animate(P,4,5,8,t.step);return}this.canJump?Math.abs(this.speed.x)<.01?this.spr.setFrame(0,0):(P=this.running?1:0,m=10-Math.abs(this.speed.x)*4,this.spr.animate(P,1,4,m|0,t.step)):(y=1,this.speed.y>.75?y=2:this.speed.y<-.75&&(y=0),this.flapping&&(y=3),this.doubleJump&&this.jumpTimer>0||this.flapping?P=7:P=2,this.spr.setFrame(y,P))}}updateJump(t){this.jumpMargin>0&&(this.jumpMargin-=t.step),this.jumpTimer>0&&(this.canJump?this.jumpTimer=0:(this.jumpTimer-=t.step,this.doubleJump?this.speed.y=Math.max(-1.25,this.speed.y+-.3*t.step):(this.speed.y=-this.jumpSpeed,this.touchWater&&(this.speed.y/=2)),this.jumpTimer<=0&&this.doubleJump&&(this.jumpReleased=!0,this.flapping=!0)))}updateDust(t){for(let y of this.dust)y.update(t);let l=!this.spinning&&!this.throwing&&(this.doubleJump&&this.jumpTimer>0||this.flapping);if(!l&&(this.sliding||!this.canJump||this.spinning||this.knockbackTimer>0||Math.abs(this.speed.x)<=.01))return;let p=this.flip==S.None?1:-1,d=8/Math.abs(this.speed.x),u=new c,m=new c(this.pos.x-2*p,this.pos.y+6);l&&(u.y=this.flapping?1:.5,d=6,m.x-=p),(this.dustTimer+=t.step)>=d&&(Te(this.dust,Zs).spawn(m.x,m.y,8,u,l?1:0),l&&t.audio.playSample(t.assets.getSample("rocket"),.5),this.dustTimer-=d)}resetFlags(){this.canJump=!1,this.touchLadder=!1,this.isLadderTop=!1,this.showActionSymbol=!1,this.holdingItem=!1,this.touchWater=!1,this.hasTeleported=!1,this.actionSymbolId=0}preMovementEvent(t){F.instance=this;const e=60;if(this.takeCameraBorderCollision=this.isInFinalArea||this.knockbackTimer>0,this.updateDust(t),this.knockbackTimer>0){(this.knockbackTimer-=t.step)<=0&&(this.health<=0?this.startDeath(t):this.invulnerabilityTimer=e),this.resetFlags();return}this.control(t),this.animate(t),this.updateJump(t),this.resetFlags(),this.invulnerabilityTimer>0&&(this.invulnerabilityTimer-=t.step)}die(t){for(let i of this.dust)i.update(t);return this.spr.animate(7,4,7,4,t.step),(this.deathTimer+=t.step)>90}resetProperties(t){t&&this.stopMovement(),this.doubleJump=!1,this.downAttacking=!1,this.downAttackWaitTimer=0,this.jumpTimer=0,this.throwing=!1,this.climbing=!1,this.touchLadder=!1,this.running=!1,this.flapping=!1,this.spinning=!1,this.touchWater=!1,this.target.y=Qe}markRoomVisited(t,e,s){let i=Math.floor(s.width/10);t=V(t,i),this.progress.addValueToArray("roomVisited",e*i+t,!0)}stageEvent(t,e){let s;this.hasTeleported&&(s=e.getRealPosition(),this.markRoomVisited(s.x,s.y,t),this.hasTeleported=!1)}cameraMovement(t,e){let i=12*t.getSpeed(),h=t.getDirection();this.pos.x+=i*h.x*e.step,this.pos.y+=i*h.y*e.step,this.animate(e)}cameraEvent(t,e,s){let l=t.getPosition(),p=l.x,d=l.y,u=l.x+t.width,m=l.y+t.height,y=0,P=0,w=this.climbing?0:1;this.pos.x-4<p?y=-1:this.pos.x+4>u?y=1:this.pos.y-4+w<d&&!this.downAttacking?P=-1:this.pos.y+4>m&&(P=1),this.isInFinalArea&&(y=0);let x;(y!=0||P!=0)&&(t.move(y,P,.05),x=t.getRealPosition(),x.x+=y,x.y+=P,this.markRoomVisited(x.x,x.y,e))}preDraw(t){for(let e of this.dust)e.draw(t)}drawDeath(t){let i=t.assets.getBitmap("player"),h=this.deathTimer*1,a,o,l=0;for(let p=0;p<8;++p)l=Math.PI*2/8*p,a=this.pos.x+this.center.x+Math.cos(l)*h,o=this.pos.y+this.center.y+Math.sin(l)*h,t.drawSprite(this.spr,i,Math.floor(a)-8,Math.floor(o)-8)}draw(t){if(!this.exist)return;if(this.dying){this.drawDeath(t);return}let e=Math.round(this.pos.x-this.spr.width/2),s=Math.round(this.pos.y-this.spr.height/2);this.showActionSymbol&&t.drawSprite(this.sprActionSymbol,t.assets.getBitmap("symbol"),e,s-14),!(!this.exist||this.invulnerabilityTimer>0&&Math.floor(this.invulnerabilityTimer/4)%2==0)&&(this.spinning?t.drawSprite(this.sprSpin,t.assets.getBitmap("spin"),e-8,s,this.flip):t.drawSprite(this.spr,t.assets.getBitmap("player"),e,s,this.flip),this.holdingItem&&t.drawBitmapRegion(t.assets.getBitmap("items"),this.itemID*16,0,16,16,e,s-17))}verticalCollisionEvent(t,e){t==1?(this.canJump=!0,this.jumpMargin=12,this.jumpTimer=0,this.doubleJump=!1,this.climbing=!1,this.canThrow=!0,this.canSpin=!0,this.downAttacking&&(this.downAttacking=!1,this.downAttackWaitTimer=30,e.shake(30,2),e.audio.playSample(e.assets.getSample("shake"),.5))):(this.jumpTimer=0,this.doubleJump&&(this.jumpReleased=!0,this.flapping=!0))}wallCollisionEvent(t,e){this.sliding=!1,this.slideTimer=0}ladderCollision(t,e,s,i,h,a){return W(this.pos,this.center,this.collisionBox,t,e,s,i)?(this.climbX=t+s/2,this.touchLadder=!h||!this.climbing,this.isLadderTop=this.isLadderTop||h,this.climbing||(this.showActionSymbol=!0,this.actionSymbolId=h?1:0),!0):!1}breakCollision(t,e,s,i,h,a){return e+=-4,h==1?!1:this.spinning&&this.progress.doesValueExistInArray("items",8)?W(this.pos,new c(0,-this.spinHitbox.y/2),this.spinHitbox,t,e,s,i):this.speed.y<0&&this.progress.doesValueExistInArray("items",10)&&W(this.pos,new c(0,-this.collisionBox.y/2),new c(this.collisionBox.x,8),t,e,s,i)?(this.speed.y=0,this.jumpTimer=0,!0):!this.downAttacking||this.speed.y<=0?!1:W(this.pos,this.center,this.collisionBox,t,e,s,i)}hurt(t,e){this.spr.setFrame(4,3),this.knockbackTimer=30,t==0&&(t=-this.faceDir),this.target.x=0,this.speed.x=2*t,this.resetProperties(!1),this.health=Math.max(0,this.health-1),e.audio.playSample(e.assets.getSample("hurt"),.6)}hurtCollision(t,e,s,i,h,a){return this.dying||this.invulnerabilityTimer>0||this.knockbackTimer>0?!1:W(this.pos,this.center,this.hitbox,t,e,s,i)?(this.hurt(h,a),!0):!1}windCollision(t,e,s,i,h){return W(this.pos,this.center,this.hitbox,t,e,s,i)?(this.flapping=!1,this.downAttacking=!1,this.downAttackWaitTimer=0,this.jumpReleased=!1,this.speed.y=Math.max(-3,this.speed.y+-.5*h.step),!0):!1}waterCollision(t,e,s,i,h,a){return this.inside||W(this.pos,this.center,this.hitbox,t,e,s,i)&&(this.jumpMargin=1,this.touchWater=!0,this.canThrow=!0,this.canSpin=!0,this.flapping=!1,this.doubleJump=!1,this.downAttacking=!1,this.downAttackWaitTimer=0,!h&&!this.progress.doesValueExistInArray("items",7)&&(this.speed.y+=-.25*a.step)),!1}projectileCollision(t,e){return t.isFriendly()||t.isDying()||!t.doesExist()||!this.doesExist()||this.dying||this.invulnerabilityTimer>0||this.knockbackTimer>0?!1:this.overlayObject(t)?(this.hurt(Math.sign(this.pos.x-t.getPos().x),e),t.destroy(e),!0):!1}makeJump(t){this.downAttacking||(this.speed.y=t,this.flapping=!1,this.jumpReleased=!1,this.doubleJump=!1,this.canSpin=!0,this.canThrow=!0)}checkLoop(t){this.pos.x=V(this.pos.x,t.width*16)}showSymbol(){this.showActionSymbol=!0,this.actionSymbolId=0}setObtainItemPose(t){this.stopMovement(),this.spr.setFrame(4,4),this.showActionSymbol=!1,this.holdingItem=!0,this.itemID=t}setUsePose(t=-1,e=!1){this.stopMovement(),this.spr.setFrame(e?5:3,3),t>=0&&(this.pos.x=t),this.showActionSymbol=!1}teleportTo(t,e=!0,s=!1){e&&this.spr.setFrame(2,3),this.inside=s,this.pos=t.clone(),this.hasTeleported=!0}setActiveCheckpointReference(t){this.activeCheckpoint=t}maximizeHealth(){this.health=this.maxHealth()}respawn(){this.activeCheckpoint==null?(this.pos=this.startPos.clone(),this.inside=this.startInside):(this.pos=this.activeCheckpoint.getPos().clone(),this.pos.y+=1,this.inside=!1),this.exist=!0,this.dying=!1,this.flip=S.None,this.invulnerabilityTimer=0,this.knockbackTimer=0,this.spr.setFrame(5,1),this.resetProperties(!0),this.resetFlags(),this.canJump=!0,this.maximizeHealth()}startDeath(t){this.dying||(this.health=0,this.deathTimer=0,this.dying=!0,t.audio.stopMusic(),t.audio.playSample(t.assets.getSample("die"),.45))}setSleepPose(){this.spr.setFrame(5,1)}}class Qs{constructor(t,e){this.data=e,this.activeBuffer=null,this.gain=t.createGain(),this.startTime=0,this.pauseTime=0,this.playVol=0,this.loop=!1}play(t,e=1,s=!1,i=0){this.fadeIn(t,e,e,s,i,0)}fadeIn(t,e,s,i=!1,h=0,a=0){this.activeBuffer!=null&&(this.activeBuffer.disconnect(),this.activeBuffer=null);let o=t.createBufferSource();o.buffer=this.data,o.loop=!!i,e=ut(e,0,1),s=ut(s,0,1),a!=null?this.gain.gain.setValueAtTime(e,h):this.gain.gain.value=e,this.startTime=t.currentTime-h,this.pauseTime=0,this.playVol=s,this.loop=i,o.connect(this.gain).connect(t.destination),o.start(0,h),a>0&&this.gain.gain.exponentialRampToValueAtTime(s,h+a/1e3),this.activeBuffer=o}stop(){this.activeBuffer!=null&&(this.activeBuffer.disconnect(),this.activeBuffer.stop(0),this.activeBuffer=null)}pause(t){this.activeBuffer!=null&&(this.pauseTime=t.currentTime-this.startTime,this.stop())}resume(t){this.play(t,this.playVol,this.loop,this.pauseTime)}}class ti{constructor(t){this.max=d=>Math.max(...this.layers[ut(d,0,this.layers.length)]);let s=new DOMParser().parseFromString(t,"text/xml").getElementsByTagName("map")[0];this.width=Number(s.getAttribute("width")),this.height=Number(s.getAttribute("height"));let i=s.getElementsByTagName("layer");this.layers=new Array;let h=9999;for(let d of i)d.id<h&&(h=d.id);let a,o,l;for(let d=0;d<i.length;++d){l=Number(i[d].id)-h,a=i[d].getElementsByTagName("data")[0].childNodes[0].nodeValue.replace(/(\r\n|\n|\r)/gm,""),o=a.split(","),this.layers[l]=new Array;for(let u=0;u<o.length;++u)this.layers[l][u]=parseInt(o[u])}this.properties=new Array;let p=s.getElementsByTagName("properties")[0];if(p!=null)for(let d of p.getElementsByTagName("property"))d.getAttribute("name")!=null&&this.properties.push(new pt(d.getAttribute("name"),d.getAttribute("value")))}getTile(t,e,s){return t<0||t>=this.layers.length||e<0||s<0||e>=this.width||s>=this.height?-1:this.layers[t][s*this.width+e]}getIndexedTile(t,e){return t<0||t>=this.layers.length||e<0||e>=this.width*this.height?-1:this.layers[t][e]}cloneLayer(t){return t<0||t>=this.layers.length?null:Array.from(this.layers[t])}cloneLayers(t=this.layers.length){return new Array(t).fill(null).map((e,s)=>this.cloneLayer(s))}getProperty(t){for(let e of this.properties)if(e.key==t)return e.value;return""}}class le{constructor(){this.assets=new Array}getAsset(t){for(let e of this.assets)if(e.key==t)return e.value;return null}addAsset(t,e){this.assets.push(new pt(t,e))}}class ei{constructor(t){this.getBitmap=e=>this.bitmaps.getAsset(e),this.getSample=e=>this.samples.getAsset(e),this.getTilemap=e=>this.tilemaps.getAsset(e),this.getDocument=e=>this.documents.getAsset(e),this.bitmaps=new le,this.samples=new le,this.tilemaps=new le,this.documents=new le,this.total=0,this.loaded=0,this.audio=t}loadTextFile(t,e,s){let i=new XMLHttpRequest;i.overrideMimeType("text/"+e),i.open("GET",t,!0),++this.total,i.onreadystatechange=()=>{i.readyState==4&&(String(i.status)=="200"&&s!=null&&s(i.responseText),++this.loaded)},i.send(null)}loadBitmap(t,e){++this.total;let s=new Image;s.onload=()=>{++this.loaded,this.bitmaps.addAsset(t,s)},s.src=e}loadSample(t,e){++this.total;let s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=()=>{this.audio.getContext().decodeAudioData(s.response,i=>{++this.loaded,this.samples.addAsset(t,new Qs(this.audio.getContext(),i))})},s.send(null)}loadTilemap(t,e){++this.total,this.loadTextFile(e,"xml",s=>{this.tilemaps.addAsset(t,new ti(s)),++this.loaded})}loadDocument(t,e){++this.total,this.loadTextFile(e,"json",s=>{this.documents.addAsset(t,s),++this.loaded})}parseAssetIndexFile(t){this.loadTextFile(t,"json",e=>{let s=JSON.parse(e),i;if(s.bitmapPath!=null&&s.bitmaps!=null){i=s.bitmapPath;for(let h of s.bitmaps)this.loadBitmap(h.name,i+h.path)}if(s.samplePath!=null&&s.samples!=null){i=s.samplePath;for(let h of s.samples)this.loadSample(h.name,i+h.path)}if(s.tilemapPath!=null&&s.tilemaps!=null){i=s.tilemapPath;for(let h of s.tilemaps)this.loadTilemap(h.name,i+h.path)}if(s.documentPath!=null&&s.documents!=null){i=s.documentPath;for(let h of s.documents)this.loadDocument(h.name,i+h.path)}})}hasLoaded(){return this.loaded>=this.total}dataLoadedUnit(){return this.total==0?1:this.loaded/this.total}}class si{constructor(){this.getContext=()=>this.ctx,this.getGlobalSampleVolume=()=>this.globalSampleVol,this.getGlobalMusicVolume=()=>this.globalMusicVol,this.ctx=new AudioContext,this.musicTrack=null,this.globalSampleVol=1,this.globalMusicVol=1,this.enabled=!1}playSample(t,e=1){!this.enabled||this.globalSampleVol<=.001||t.play(this.ctx,this.globalSampleVol*e,!1,0)}playMusic(t,e=1){this.enabled&&this.fadeInMusic(t,e,0)}fadeInMusic(t,e=1,s=0){if(!this.enabled||this.globalMusicVol<=.001)return;this.musicTrack!=null&&(this.musicTrack.stop(),this.musicTrack=null);let h=this.globalMusicVol*e;t.fadeIn(this.ctx,s==null?h:.01,h,!0,0,s),this.musicTrack=t}toggle(t){this.enabled=t}setGlobalSampleVolume(t=1){this.globalSampleVol=ut(t,0,1)}setGlobalMusicVolume(t=1){this.globalMusicVol=ut(t,0,1)}pauseMusic(){!this.enabled||this.musicTrack==null||this.musicTrack.pause(this.ctx)}resumeMusic(){!this.enabled||this.musicTrack==null||this.musicTrack.resume(this.ctx)}stopMusic(){!this.enabled||this.musicTrack==null||(this.musicTrack.stop(),this.musicTrack=null)}}class ii{constructor(){this.isAnyButtonPressed=()=>this.anyPressed,this.getStick=()=>this.stick.clone(),this.stick=new c,this.buttons=new Array,this.pad=null,this.index=-1,window.addEventListener("gamepadconnected",t=>{if(this.index<0)console.log("Gamepad with index "+String(t.gamepad.index)+" connected.");else{console.log("Gamepad with index "+String(t.gamepad.index)+" connected but ignored due to some weird technical reasons.");return}let e=navigator.getGamepads()[t.gamepad.index];this.index=t.gamepad.index,this.pad=e,this.updateGamepad(this.pad)}),this.anyPressed=!1}pollGamepads(){if(navigator!=null)return navigator.getGamepads()}updateButtons(t){if(t==null){for(let e=0;e<this.buttons.length;++e)this.buttons[e]=E.Up;return}for(let e=0;e<t.buttons.length;++e){if(e>=this.buttons.length)for(let s=0;s<e-this.buttons.length;++s)this.buttons.push(E.Up);t.buttons[e].pressed?this.buttons[e]==E.Up||this.buttons[e]==E.Released?(this.anyPressed=!0,this.buttons[e]=E.Pressed):this.buttons[e]=E.Down:this.buttons[e]==E.Down||this.buttons[e]==E.Pressed?this.buttons[e]=E.Released:this.buttons[e]=E.Up}}updateStick(t){let s=!0;t!=null&&(this.stick.x=0,this.stick.y=0,Math.abs(t.axes[0])>=.25&&(this.stick.x=t.axes[0],s=!1),Math.abs(t.axes[1])>=.25&&(this.stick.y=t.axes[1],s=!1),t.axes.length>=8&&s&&(Math.abs(t.axes[6])>=.25&&(this.stick.x=t.axes[6]),Math.abs(t.axes[7])>=.25&&(this.stick.y=t.axes[7])))}updateGamepad(t){this.updateStick(t),this.updateButtons(t)}refreshGamepads(){if(this.pad==null)return;let t=this.pollGamepads();t!=null&&(this.pad=t[this.index])}update(){this.anyPressed=!1,this.stick.x=0,this.stick.y=0,this.refreshGamepads(),this.updateGamepad(this.pad)}getButtonState(t){return t==null||t<0||t>=this.buttons.length?E.Up:this.buttons[t]}}class hi{constructor(){this.isAnyPressed=()=>this.anyPressed,this.keys=new Array,this.prevent=new Array,this.prevent.push("ArrowUp"),this.prevent.push("ArrowDown"),this.prevent.push("ArrowLeft"),this.prevent.push("ArrowRight"),this.prevent.push("Space"),this.anyPressed=!1,window.addEventListener("keydown",t=>{this.keyPressed(t.code),this.prevent.includes(t.code)&&t.preventDefault()}),window.addEventListener("keyup",t=>{this.keyReleased(t.code),this.prevent.includes(t.code)&&t.preventDefault()}),window.addEventListener("contextmenu",t=>{t.preventDefault()}),window.addEventListener("mousemove",t=>{window.focus()}),window.addEventListener("mousedown",t=>{window.focus()})}setKeyState(t,e){for(let s of this.keys)if(s.key==t){s.value=e;return}this.keys.push(new pt(t,e))}keyPressed(t){this.getKeyState(t)!=E.Down&&(this.anyPressed=!0,this.setKeyState(t,E.Pressed))}keyReleased(t){this.getKeyState(t)!=E.Up&&this.setKeyState(t,E.Released)}update(){for(let t of this.keys)t.value==E.Released?t.value=E.Up:t.value==E.Pressed&&(t.value=E.Down);this.anyPressed=!1}getKeyState(t){for(let e of this.keys)if(e.key==t)return e.value;return E.Up}}const ce=.25;class ai{constructor(t,e,s=null,i=-1,h=-1){this.getState=()=>this.state,this.name=t,this.key1=e,this.key2=s,this.button1=i,this.button2=h,this.state=E.Up}setState(t){this.state=t}}class ri{constructor(){this.getStick=()=>this.stick.clone(),this.anyPressed=()=>this.keyboard.isAnyPressed()||this.gamepad.isAnyButtonPressed(),this.keyboard=new hi,this.gamepad=new ii,this.actions=new Array,this.stick=new c,this.oldStick=new c,this.stickDelta=new c,this.addAction("right","ArrowRight",null,15).addAction("up","ArrowUp",null,12).addAction("left","ArrowLeft",null,14).addAction("down","ArrowDown",null,13)}addAction(t,e,s=null,i=-1,h=-1){return this.actions.push(new ai(t,e,s,i,h)),this}getAction(t){for(let e of this.actions)if(e.name==t)return e.getState();return E.Up}updateStick(){let e=this.gamepad.getStick();this.oldStick=this.stick.clone(),this.stick.zeros(),Math.abs(e.x)>=.25||Math.abs(e.y)>=.25?this.stick=e:(this.getAction("right")&E.DownOrPressed?this.stick.x=1:this.getAction("left")&E.DownOrPressed&&(this.stick.x=-1),this.getAction("down")&E.DownOrPressed?this.stick.y=1:this.getAction("up")&E.DownOrPressed&&(this.stick.y=-1)),this.stickDelta=new c(this.stick.x-this.oldStick.x,this.stick.y-this.oldStick.y)}preUpdate(){this.gamepad.update();let t;for(let e of this.actions)t=this.keyboard.getKeyState(e.key1),t==E.Up&&(e.key2!=null&&(t=this.keyboard.getKeyState(e.key2)),t==E.Up&&e.button1>=0&&(t=this.gamepad.getButtonState(e.button1),t==E.Up&&e.button2>=0&&(t=this.gamepad.getButtonState(e.button2)))),e.setState(t);this.updateStick()}postUpdate(){this.keyboard.update()}upPress(){return this.stick.y<0&&this.oldStick.y>=-.25&&this.stickDelta.y<-.25}downPress(){return this.stick.y>0&&this.oldStick.y<=ce&&this.stickDelta.y>ce}leftPress(){return this.stick.x<0&&this.oldStick.x>=-.25&&this.stickDelta.x<-.25}rightPress(){return this.stick.x>0&&this.oldStick.x<=ce&&this.stickDelta.x>ce}}class ni{constructor(){this.data=null}initialize(t){this.data=JSON.parse(t)}findValue(t){let e=this.data;try{for(let s of t)e=e[s];return e}catch{}return null}}var D=(r=>(r[r.None=0]="None",r[r.Fade=1]="Fade",r[r.CirleIn=2]="CirleIn",r[r.BoxVertical=3]="BoxVertical",r[r.BoxHorizontal=4]="BoxHorizontal",r[r.CircleOut=5]="CircleOut",r[r.HorizontalWavesWithFading=6]="HorizontalWavesWithFading",r))(D||{});class oi{constructor(){this.isActive=()=>this.active,this.isFadingIn=()=>this.active&&this.fadeIn,this.timer=0,this.fadeIn=!1,this.effectType=0,this.color=[0,0,0],this.active=!1,this.center=new c,this.speed=1,this.param=null,this.callback=t=>{}}activate(t,e,s,i,h=[0,0,0],a=0,o=new c){return this.fadeIn=t,this.speed=s,this.timer=1,this.callback=i,this.effectType=e,this.color=h,this.param=a,this.vecParam=o.clone(),this.active=!0,this}setCenter(t){return this.center=t.clone(),this}update(t){this.active&&(this.timer-=this.speed*t.step)<=0&&(this.fadeIn=!this.fadeIn,this.fadeIn?(this.active=!1,this.timer=0):(this.timer+=1,this.callback(t)))}fade(t,e,s){s>0&&(e=Math.round(e*s)/s),t.setGlobalAlpha(e),t.fillRect(0,0,t.width,t.height),t.setGlobalAlpha()}draw(t){if(!this.active||this.effectType==0)return;t.moveTo();let e=this.timer;this.fadeIn&&(e=1-e);let s,i;switch(t.setFillColor(this.color[0],this.color[1],this.color[2]),this.effectType){case 1:this.fade(t,e,this.param);break;case 2:s=Math.max(Math.hypot(this.center.x,this.center.y),Math.hypot(t.width-this.center.x,this.center.y),Math.hypot(t.width-this.center.x,t.height-this.center.y),Math.hypot(this.center.x,t.height-this.center.y)),i=(1-e)*s,t.fillCircleOutside(i,this.center.x,this.center.y);break;case 3:i=Math.round(e*t.height/2),t.fillRect(0,0,t.width,i),t.fillRect(0,t.height-i,t.width,i);break;case 5:s=Math.max(Math.hypot(this.center.x,this.center.y),Math.hypot(t.width-this.center.x,this.center.y),Math.hypot(t.width-this.center.x,t.height-this.center.y),Math.hypot(this.center.x,t.height-this.center.y)),i=e*s,t.fillCircle(i,this.center.x,this.center.y);break;case 6:t.fillScreenWithWavingCenteredImage(null,this.vecParam.x,this.vecParam.y,e),this.fade(t,e,this.param);break}}deactivate(){this.active=!1}}class li{constructor(t,e,s,i,h,a,o){this.shake=(l,p)=>this.canvas.shake(l,p),this.isShaking=()=>this.canvas.isShaking(),this.core=e,this.step=t,this.input=s,this.assets=i,this.transition=h,this.audio=a,this.canvas=o,this.localization=new ni}changeScene(t){this.core.changeScene(t)}prepareLocalization(t){this.localization.initialize(this.assets.getDocument(t))}copyCanvasToBuffer(){this.core.forceRedraw(),this.canvas.copyCanvasToBuffer()}}class dt{constructor(t,e,s=0){this.audio=new si,this.input=new ri,this.assets=new ei(this.audio),this.canvas=new $s(t,e,this.assets),this.transition=new oi,this.archipelago=H.getInstance(),this.event=new li(s+1,this,this.input,this.assets,this.transition,this.audio,this.canvas),this.timeSum=0,this.oldTime=0,this.initialized=!1,this.activeScene=null,this.activeSceneType=null}static getInstance(){return dt.instance}drawLoadingScreen(t){let s=t.width/4,i=s/8;t.clear(0,0,0);let h=this.assets.dataLoadedUnit(),a=t.width/2-s/2,o=t.height/2-i/2;a|=0,o|=0,t.setFillColor(255),t.fillRect(a-1*2,o-1*2,s+1*4,i+1*4),t.setFillColor(0),t.fillRect(a-1,o-1,s+1*2,i+1*2);let l=s*h|0;t.setFillColor(255),t.fillRect(a,o,l,i)}loop(t,e){var a;dt.instance=this;const s=5,i=16.66667*this.event.step;this.timeSum+=t-this.oldTime,this.timeSum=Math.min(s*i,this.timeSum),this.oldTime=t;let h=this.timeSum/i|0;for(;h-- >0;){if(!this.initialized&&this.assets.hasLoaded()&&(e(this.event),this.activeScene=new this.activeSceneType.prototype.constructor(null,this.event),this.initialized=!0),this.input.preUpdate(),this.initialized){if(document.activeElement!=null&&((a=document.activeElement)==null?void 0:a.tagName)=="INPUT")continue;this.activeScene.update(this.event)}this.input.postUpdate(),this.transition.update(this.event),this.canvas.update(this.event),this.timeSum-=i}this.initialized?(this.activeScene.redraw(this.canvas),this.transition.draw(this.canvas)):this.drawLoadingScreen(this.canvas),window.requestAnimationFrame(o=>this.loop(o,e))}run(t,e=null,s=()=>{},i=()=>{}){e!=null&&this.assets.parseAssetIndexFile(e),this.activeSceneType=t,s(this.event),this.loop(0,i)}forceRedraw(){this.activeScene.redraw(this.canvas)}changeScene(t){let e=this.activeScene.dispose();this.activeScene=new t.prototype.constructor(e,this.event)}}const pe=(r,t,e)=>{for(let s of r)if(s.key==t)return s.value;return e},ts=(r,t,e)=>{for(let s of r)if(s.key==t){s.value=e;return}r.push(new pt(t,e))},es=r=>{let t=`{
`,e;for(let s=0;s<r.length;++s)e=r[s],t+='"'+e.key+'": '+String(e.value),s!=r.length-1&&(t+=","),t+=`
`;return t+="}",t},ci=r=>{let t=`{
`,e;for(let s=0;s<r.length;++s){e=r[s],t+='"'+e.key+'": [';for(let i=0;i<e.value.length;++i)t+=String(e.value[i]),i!=e.value.length-1&&(t+=",");t+="]",s!=r.length-1&&(t+=","),t+=`
`}return t+="}",t};class N{constructor(){this.setBooleanProperty=(t,e=!0)=>ts(this.booleanProperties,t,e),this.getBooleanProperty=t=>pe(this.booleanProperties,t,!1),this.setNumberProperty=(t,e=0)=>ts(this.numberProperties,t,e),this.getNumberProperty=(t,e=-1)=>pe(this.numberProperties,t,e),this.dump=()=>'"boolProp": '+es(this.booleanProperties)+`,
"numberProp": `+es(this.numberProperties)+`,
"arrayProp": `+ci(this.numberArrayProperties),this.booleanProperties=new Array,this.numberProperties=new Array,this.numberArrayProperties=new Array}static getInstance(){return N.instance||(N.instance=new N),N.instance}static reset(){N.instance=null}increaseNumberProperty(t,e=1){for(let s of this.numberProperties)if(s.key==t){s.value+=e;return}this.setNumberProperty(t,e)}addValueToArray(t,e,s=!0){let i=null;for(let h of this.numberArrayProperties)if(h.key==t){i=h.value;break}i==null&&(i=new Array,this.numberArrayProperties.push(new pt(t,i))),!(s&&i.includes(e))&&i.push(e)}removeValueFromArray(t,e){let s=pe(this.numberArrayProperties,t,null);if(s==null)return;const i=s.indexOf(e);i<0||s.splice(i,1)}doesValueExistInArray(t,e){let s=pe(this.numberArrayProperties,t,null);return s==null?!1:s.includes(e)}recoverFromJSON(t){this.booleanProperties=new Array,this.numberProperties=new Array,this.numberArrayProperties=new Array;for(let e in t.arrayProp)this.numberArrayProperties.push(new pt(e,Array.from(t.arrayProp[e])));for(let e in t.boolProp)this.booleanProperties.push(new pt(e,t.boolProp[e]));for(let e in t.numberProp)this.numberProperties.push(new pt(e,t.numberProp[e]))}}class H{static getInstance(){return H.instance||(H.instance=new H),H.instance}constructor(){this.showConnected(!1),this.client=new Xs,console.log("Created archipelago client"),this.client.messages.on("message",t=>{console.log(t)}),this.client.items.on("itemsReceived",t=>this.onReceive(t)),document.getElementById("input-chat").addEventListener("keydown",t=>{if(t.key==="Enter"){t.preventDefault();const e=t.target;this.input(e.value),e.value=""}}),document.getElementById("connect").addEventListener("click",t=>{this.login(document.getElementById("input-host").value,document.getElementById("input-port").value,document.getElementById("input-slot").value,document.getElementById("input-password").value)})}login(t,e,s,i){this.client.login(t+":"+e,s,"Insomnia a sleepless journey",{password:i}).then(()=>this.onConnect()).catch(function(h){console.error(h),alert(h)})}onConnect(){console.log("Connected to the Archipelago server!"),this.showConnected(!0)}input(t){this.client.messages.say(t)}showId(t,e){document.getElementById(t).style.setProperty("display",e?"":"none")}showConnected(t){this.showId("connection-inputs",!t),this.showId("cdiv",t),this.showId("input-chat",t)}onReceive(t){const e=document.getElementById("log");e.innerText="";for(const s of t){e.innerText+=`Received ${s.name} at ${s.locationName}
`;const i=s.id-1;switch(i){case 13:N.getInstance().setBooleanProperty("fansEnabled"),e.style.color="#FFFFFF";break;case 14:N.getInstance().increaseNumberProperty("stars"),e.style.color="#F4FF00";break;case 15:N.getInstance().increaseNumberProperty("kills"),e.style.color="#FF0000";break;default:N.getInstance().doesValueExistInArray("items",i)||this.receiveEquipment(i),e.style.color="#FFFFFF";break}}}updateReceivedItems(){N.getInstance().setNumberProperty("stars",0),N.getInstance().setNumberProperty("kills",0),this.onReceive(this.client.items.received)}receiveEquipment(t){if(N.getInstance().addValueToArray("items",t,!0),!dt.getInstance()||!F.getInstance())return;const e=dt.getInstance().event;let s=e.localization.findValue(["chest",String(t)]);if(s==null)return;const i=[-1,6,-1,7,8,9,-1,-1,-1,-1,-1,10],h=45;e.audio.playSample(e.assets.getSample("item"),.4),e.audio.pauseMusic();const a=dt.getInstance().activeScene;if(a instanceof ze){const l=a.message,p=a.hintbox;l.addMessages(s),l.activate(h,!1,d=>{t<i.length&&i[t]>=0&&(p.setMessage(d.localization.findValue(["hints",String(i[t])])),p.activate()),d.audio.resumeMusic()})}F.getInstance().setObtainItemPose(t)}toggleFans(){const t=F.getInstance().progress;t.setBooleanProperty("fansEnabled",!t.getBooleanProperty("fansEnabled"))}removeEquipment(t){F.getInstance().progress.removeValueFromArray("items",t)}teleportToRoom(t,e){const s=F.getInstance(),i=s.pos.clone(),h=new c(i.x%160,i.y%144),a=new c(t*160+h.x,e*144+h.y);s.pos=a}}class pi{constructor(t,e,s,i){this.getPosition=()=>new c(this.renderPos.x*this.width,this.renderPos.y*this.height),this.getRealPosition=()=>this.pos.clone(),this.getDelta=()=>new c((this.renderPos.x-this.pos.x)*this.width,(this.renderPos.y-this.pos.y)*this.height),this.getDirection=()=>c.direction(this.pos,this.target),this.getSpeed=()=>this.speed,this.isMoving=()=>this.moving,this.wasForcedToMove=()=>this.forcedToMove,this.pos=new c(t,e),this.target=this.pos.clone(),this.renderPos=this.pos.clone(),this.timer=0,this.speed=1,this.moving=!1,this.forcedToMove=!1,this.width=s,this.height=i}update(t){return this.forcedToMove=!1,this.moving?(this.timer+=this.speed*t.step)>=1?(this.pos=this.target.clone(),this.renderPos=this.pos.clone(),this.moving=!1,!0):(this.renderPos=c.lerp(this.pos,this.target,this.timer),!1):!1}move(t,e,s){Math.abs(t)<.001&&Math.abs(e)<.001||(this.target=c.add(this.pos,new c(t,e)),this.moving=!0,this.speed=s,this.timer=0)}use(t){t.move(-Math.round(this.renderPos.x*this.width),-Math.round(this.renderPos.y*this.height))}focusOnObject(t){this.pos.x=t.getPos().x/this.width|0,this.pos.y=t.getPos().y/this.height|0,this.target=this.pos.clone(),this.renderPos=this.pos.clone(),this.forcedToMove=!0}checkLoop(t){let e=t.width/(this.width/16);this.pos.x=V(this.pos.x,e),this.target.x=this.pos.x,this.renderPos.x=this.pos.x}}class Ge{constructor(){this.isActive=()=>this.active,this.active=!1}deactivate(){this.active=!1}activate(){this.active=!0}}class di extends Ge{constructor(){super(),this.message="",this.width=0}setMessage(t){if(this.message.length!=0)return;let e=t.split(`
`);this.width=Math.max(...e.map(s=>s.length)),this.height=e.length,this.message=t}update(t,e){this.active&&(t.isMoving()||e.transition.isFadingIn())&&(this.message="",this.active=!1)}draw(t){if(!this.active)return;let i=t.assets.getBitmap("fontYellow"),h=t.width/2-this.width*4;t.setFillColor(255,255,255,.33),t.fillRect(h-2,18,this.width*8+4,this.height*8+4),t.drawText(i,this.message,h,20,0,0)}}class B{constructor(t,e){this.getText=()=>this.text,this.evaluateCallback=s=>this.callback(s),this.text=t,this.callback=e}clone(){return new B(this.text,this.callback)}changeText(t){this.text=t}}class Ae extends Ge{constructor(t){super(),this.isActive=()=>this.active,this.buttons=new Array(t.length).fill(null).map((e,s)=>t[s].clone()),this.maxLength=Math.max(...this.buttons.map(e=>e.getText().length)),this.cursorPos=0,this.active=!1}activate(t=-1){t>=0&&(this.cursorPos=t%this.buttons.length),this.active=!0}update(t){if(!this.active)return;let e=this.cursorPos;t.input.upPress()?--this.cursorPos:t.input.downPress()&&++this.cursorPos,e!=this.cursorPos&&(this.cursorPos=V(this.cursorPos,this.buttons.length),t.audio.playSample(t.assets.getSample("choose"),.7));let s=this.buttons[this.cursorPos];(t.input.getAction("select")==E.Pressed||t.input.getAction("start")==E.Pressed)&&(t.audio.playSample(t.assets.getSample("select"),.5),s.evaluateCallback(t))}draw(t,e,s,i=0,h=12,a=!1){if(!this.active)return;let o="",l=t.assets.getBitmap("font"),p=t.assets.getBitmap("fontYellow"),d=(this.maxLength+1)*(8+i),u=this.buttons.length*h,m=t.width/2-d/2+e,y=t.height/2-u/2+s;a&&We(t,m,y-2,d,u);let P;for(let w=0;w<this.buttons.length;++w)o=this.buttons[w].getText(),w==this.cursorPos?(o="@"+o,P=p):P=l,t.drawText(P,o,m,y+w*h,i,0)}changeButtonText(t,e){this.buttons[t].changeText(e)}}const We=(r,t,e,s,i)=>{const a=[[85,85,170],[170,170,255],[255,255,255],[0,0,0]];for(let o=a.length-1;o>=0;--o)r.setFillColor(...a[o]),r.fillRect(t-2-o,e-2-o,s+(2+o)*2,i+(2+o)*2)};class be extends Ge{constructor(t){super(),this.isActive=()=>this.active,this.queue=new Array,this.sizes=new Array,this.currentMessage="",this.currentSize=new c,this.charTimer=0,this.charPos=0,this.ready=!1,this.active=!1,this.waitTimer=0,this.waveTimer=0;let e=t.localization;this.yesNoBox=new Ae([new B(e.findValue(["yes"]),s=>{this.deactivate(),this.confirmEvent(s)}),new B(e.findValue(["no"]),s=>{this.deactivate()})])}addMessages(t){let e;for(let s of t)this.queue.push(s),e=s.split(`
`),this.sizes.push(new c(Math.max(...e.map(i=>i.length)),e.length))}activate(t=0,e=!1,s=h=>{},i=1){this.queue.length!=0&&(this.active=!0,this.charPos=0,this.charTimer=0,this.ready=!1,this.currentMessage=this.queue.shift(),this.currentSize=this.sizes.shift().clone(),this.waitTimer=t,this.confirm=e,this.confirmEvent=s,this.yesNoBox.activate(i))}deactivate(){this.queue.length=0,this.sizes.length=0,this.active=!1}update(t){if(this.active){if(this.waitTimer>0){this.waitTimer-=t.step;return}if(this.ready)this.waveTimer=(this.waveTimer+.1)%(Math.PI*2),this.confirm&&this.queue.length==0?this.yesNoBox.update(t):t.input.anyPressed()&&(this.ready=!1,this.queue.length==0?(this.deactivate(),this.confirmEvent(t)):(this.currentMessage=this.queue.shift(),this.currentSize=this.sizes.shift().clone(),this.charPos=0,this.charTimer=0,this.ready=!1),t.audio.playSample(t.assets.getSample("choose"),.8));else for(this.waveTimer=0,this.charTimer+=t.step;this.charTimer>=.1&&!this.ready;){for(++this.charPos,this.charTimer-=.1;this.charPos<this.currentMessage.length&&[`
`," ","	"].includes(this.currentMessage[this.charPos]);)++this.charPos;this.ready=this.charPos==this.currentMessage.length}}}draw(t,e=!0){if(!this.active||this.waitTimer>0)return;let i=t.assets.getBitmap("font"),h=this.currentSize.x*8,a=this.currentSize.y*10,o=t.width/2-h/2,l=t.height/2-a/2;e&&We(t,o,l,h,a),t.drawText(i,this.currentMessage.substring(0,this.charPos),o,l,0,2);let p=Math.round(Math.sin(this.waveTimer)*1);this.ready&&(this.confirm&&this.queue.length==0?this.yesNoBox.draw(t,h/4,a/2+20,0,10,!0):t.drawBitmapRegion(i,8,0,8,8,o+h-2,l+a+p-2))}}class ss{constructor(t,e,s){this.isActive=()=>this.active,this.width=t.width/10|0,this.height=t.height/9|0,this.stars=new Array(this.width*this.height).fill(!1),this.enemies=new Array(this.width*this.height).fill(!1),this.visited=new Array(this.width*this.height).fill(!1),this.connections=new Array(this.width*this.height).fill(null),this.progress=e,this.pos=new c,this.active=!1,this.flickerTime=0,this.loc=s.localization}removeDuplicateConnections(){for(let t=0;t<this.connections.length;++t)if(this.connections[t]!=null)for(let e=0;e<this.connections.length;++e)t!=e&&this.connections[e]!=null&&this.connections[t].isEqualToOpposite(this.connections[e])&&(this.connections[e]=null)}activate(t,e,s){this.pos=s.getRealPosition();let i=Math.floor(t.width/10),h,a;for(let o=0;o<this.width*this.height;++o)this.visited[o]=this.progress.doesValueExistInArray("roomVisited",o)||this.progress.doesValueExistInArray("items",12),this.visited[o]?(h=o%i,a=o/i|0,this.stars[o]=e.hasStarInArea(h*s.width,a*s.height,s.width,s.height),this.enemies[o]=e.hasEnemyInArea(h*s.width,a*s.height,s.width,s.height),this.connections[o]=e.getDoorConnectionInArea(h*s.width,a*s.height,s.width,s.height)):(this.stars[o]=!1,this.enemies[o]=!1,this.connections[o]=null);this.removeDuplicateConnections(),this.active=!0,this.flickerTime=0}update(t){const e=.016666666666666666;this.active&&(t.input.anyPressed()&&(t.audio.playSample(t.assets.getSample("select"),.5),this.active=!1),this.flickerTime=(this.flickerTime+e)%1)}draw(t){if(!this.active)return;const s=t.assets.getBitmap("mapIcons"),i=t.assets.getBitmap("minimap");t.setFillColor(0,0,0,.67),t.fillRect();let h=this.width*10,a=this.height*9,o=t.width/2-h/2,l=t.height/2-a/2;We(t,o-2,l-2,h+2*2,a+2*2);let p;t.setFillColor(170,170,255);for(let w=0;w<this.height;++w)for(let x=0;x<this.width;++x)this.visited[w*this.width+x]&&t.fillRect(o+x*10,l+w*9,10,9);for(let w=0;w<this.height;++w)for(let x=0;x<this.width;++x)this.flickerTime<.5&&x==this.pos.x&&w==this.pos.y&&t.drawBitmapRegion(s,30,0,10,9,o+x*10,l+w*9),p=-1,this.stars[w*this.width+x]&&this.enemies[w*this.width+x]?p=0:this.stars[w*this.width+x]?p=10:this.enemies[w*this.width+x]&&(p=20),p>=0&&t.drawBitmapRegion(s,p,0,10,9,o+x*10,l+w*9);t.drawText(t.assets.getBitmap("fontYellow"),this.loc.findValue(["worldMap"]),t.width/2,8,0,0,!0),F.getInstance().progress.doesValueExistInArray("items",11)&&t.drawBitmap(i,o,l);for(let w=0;w<this.height;++w)for(let x=0;x<this.width;++x)this.visited[w*this.width+x]||(t.setFillColor(85,85,170),t.fillRect(o+x*10,l+w*9,10,9));let d,u,m,y,P=0;for(let w of this.connections){if(w==null||(d=w.x/10|0,u=w.y/9|0,m=w.w/10|0,y=w.h/9|0,!this.visited[u*this.width+d]&&!this.visited[y*this.width+m]))continue;const x=P/this.connections.length*36,z=1,it=z*(1-Math.abs(x%2-1));let J=0,j=0,G=0;x<1?(J=z,j=it,G=0):x<2?(J=it,j=z,G=0):x<3?(J=0,j=z,G=it):x<4?(J=0,j=it,G=z):x<5?(J=it,j=0,G=z):x<=6&&(J=z,j=0,G=it),t.setFillColor(J*255,j*255,G*255),t.drawPixelatedLine(o+w.x,l+w.y,o+w.w,l+w.h),P++}}}class Ve extends Me{constructor(t,e,s=!0){super(t,e,s),this.canInteract=!0}playerCollisionEvent(t,e,s){}playerEvent(t,e){}playerCollision(t,e,s){return t.isDying()||!t.doesExist()||!this.canInteract||!this.exist||!this.inCamera||this.dying?!1:(this.playerEvent(t,s),t.overlayObject(this)?(this.playerCollisionEvent(t,e,s),!0):!1)}}class mt extends Ve{constructor(t,e,s=!0){super(t,e,s)}interactionEvent(t,e,s){}extendedPlayerCollisionEvent(t,e){}playerCollisionEvent(t,e,s){this.extendedPlayerCollisionEvent(t,s),t.touchGround()&&(t.showSymbol(),s.input.upPress()&&this.interactionEvent(t,e,s))}}const ui=[S.None,S.Horizontal,S.None,S.Horizontal,S.None,S.None,S.Horizontal,S.None,S.Horizontal,S.None,S.None];class mi extends mt{constructor(t,e,s,i,h){super(t,e,!0),this.spr=new A(16,16),this.flip=ui[s],this.hitbox=new c(12,8),this.id=s,this.opened=!1,this.message=i,this.hintbox=h}interactionEvent(t,e,s){this.opened||(H.getInstance().client.check(this.id+1),t.progress.addValueToArray("openChests",this.id,!0),this.forceOpen())}draw(t){let e=t.assets.getBitmap("chest");this.inCamera&&t.drawSprite(this.spr,e,this.pos.x-this.spr.width/2,this.pos.y-this.spr.height/2,this.flip)}forceOpen(){this.opened=!0,this.canInteract=!1,this.spr.setFrame(1,0)}}class fi extends Ve{constructor(t,e,s){super(t,e,!0),this.spr=new A(16,16),this.spr.setFrame(Math.random()*8|0,0),this.hitbox=new c(12,12),this.waveTimer=Math.random()*(Math.PI*2),this.entityID=s}outsideCameraEvent(){this.dying&&(this.exist=!1)}die(t){return this.spr.animate(1,0,4,5,t.step),this.spr.getColumn()==4}updateLogic(t){this.spr.animate(0,0,7,7,t.step),this.waveTimer=(this.waveTimer+.1*t.step)%(Math.PI*2)}playerCollisionEvent(t,e,s){this.dying=!0,this.spr.setFrame(0,1),this.waveTimer=0,H.getInstance().client.check(this.entityID+15),t.progress.addValueToArray("starsCollected",this.entityID,!0),s.audio.playSample(s.assets.getSample("star"),.5)}draw(t){if(!this.exist||!this.inCamera)return;let s=this.pos.y+Math.round(Math.sin(this.waveTimer)*1);t.drawSprite(this.spr,t.assets.getBitmap("star"),this.pos.x-8,s-8)}}class gi extends mt{constructor(t,e,s,i,h){super(t,e,!0),this.getPairPos=()=>this.pair.getPos();const a=[0,2,9,10,11,12,13,16,19];this.spr=new A(16,32),this.hitbox=new c(10,8),this.open=a.includes(s)||i,this.id=s,this.inside=i,this.pair=null,this.message=h}markPair(t){this.pair==null&&(this.pair=t)}interactionEvent(t,e,s){if(this.pair==null)return;let i;if(!this.open){if(t.progress.doesValueExistInArray("items",2)?(i=s.localization.findValue(["open"]),this.open=!0,t.progress.addValueToArray("doors",this.id,!0),s.audio.playSample(s.assets.getSample("open"),.6)):(i=s.localization.findValue(["locked"]),s.audio.playSample(s.assets.getSample("select"),.5)),i==null)return;this.message.addMessages(i),this.message.activate();return}let h=t.getPos();t.setUsePose(this.pos.x),this.canInteract=!1,s.audio.stopMusic(),s.audio.playSample(s.assets.getSample("door"),.5),s.transition.activate(!0,D.CirleIn,1/30,a=>{this.canInteract=!0,t.teleportTo(c.add(this.pair.getPos(),new c(0,1)),!0,!this.inside),e.focusOnObject(t),h=t.getPos(),a.transition.setCenter(new c(h.x%160,h.y%144)),ge(a,t.isInside(),t.isInFinalArea)}).setCenter(new c(h.x%160,h.y%144))}draw(t){let e=t.assets.getBitmap("door");!this.inCamera||this.open||t.drawSprite(this.spr,e,this.pos.x-this.spr.width/2,this.pos.y-24)}forceOpen(){this.open=!0}}const is=30,Wt=class Wt extends je{constructor(t,e,s,i,h=!1){super(t,e,!0),this.isGhost=()=>this.ghost,this.hasBaseGravity=h,this.startPos=this.pos.clone(),this.id=s,this.entityID=i,this.spr=new A(16,16),this.spr.setFrame(0,this.id+2),this.starSprite=new A(16,16),this.hitbox=new c(8,8),this.collisionBox=new c(8,8),this.flip=S.None,this.canBeKnockedDown=!0,this.knockDownTimer=0,this.friction=new c(.1,.15),h&&(this.target.y=Wt.BASE_GRAVITY),this.canJump=!1,this.oldCanJump=this.canJump,this.knockDownYOffset=0,this.previousShakeState=!1,this.canBeStomped=!0,this.canBeSpun=!0,this.knockOnStomp=!1,this.killOnStomp=!0,this.dieOnProjectile=!0,this.deathTimer=0,this.deathMode=0,this.deathPos=this.pos.clone(),this.dir=-1+2*(Math.floor(t/16)%2),this.ghost=!1,this.oldCameraState=!1}setProjectileCallback(t){this.projectileCb=t}outsideCameraEvent(){if(this.dying){this.deathMode==1&&this.deathTimer>0?this.inCamera=!0:this.exist=!1;return}!this.inCamera&&this.oldCameraState&&(this.forceReset=!0)}die(t){return this.flip=S.None,this.deathMode==0?this.spr.getColumn()<4&&this.spr.animate(0,0,4,4,t.step):(this.target.y=4,this.updateMovement(t)),this.starSprite.animate(1,0,3,3,t.step),this.deathTimer-=t.step,this.deathMode==0&&this.deathTimer<=0}updateAI(t){}knockDown(t=!0){this.target.x=0,this.speed.x=0,this.knockDownTimer=150,t&&(this.speed.y=-2.5*(this.friction.y/.15)),this.spr.setFrame(0,this.spr.getRow())}preMovementEvent(t){if(this.oldCameraState=this.inCamera,this.canJump&&t.isShaking()&&(this.knockDownTimer<=0||!this.previousShakeState)&&this.canBeKnockedDown&&this.knockDown(!0),this.knockDownTimer>0){this.knockDownTimer-=t.step;return}this.updateAI(t),this.previousShakeState=t.isShaking()}postMovementEvent(t){this.oldCanJump=this.canJump,this.canJump=!1}drawDeath(t){const e=[6,4],s=[Math.PI/2/3,Math.PI/4],i=32;if(this.deathTimer<=0)return;let h=e[this.deathMode],a=s[this.deathMode],o=t.assets.getBitmap("enemies"),l=1-this.deathTimer/is,p,d,u,m=Math.round(this.deathPos.x),y=Math.round(this.deathPos.y);for(let P=0;P<h;++P)p=a+P*(Math.PI*2/h),d=m+Math.cos(p)*l*i,u=y+Math.sin(p)*l*i,t.drawSprite(this.starSprite,o,Math.round(d)-this.spr.width/2,Math.round(u)-this.spr.height/2,this.flip)}preDraw(t){}draw(t){if(!this.exist||!this.inCamera||this.dying&&(this.drawDeath(t),this.spr.getColumn()==4))return;this.ghost&&t.setGlobalAlpha(.75),this.preDraw(t);let s=Math.round(this.pos.x)-this.spr.width/2,i=Math.round(this.pos.y)-this.spr.height/2,h=this.flip;(this.knockDownTimer>0||this.dying&&this.deathMode==1)&&(h|=S.Vertical,i+=this.knockDownYOffset);let a=t.assets.getBitmap(this.ghost?"ghosts":"enemies");t.drawSprite(this.spr,a,s,i,h),this.ghost&&t.setGlobalAlpha()}cameraEvent(t){!this.inCamera&&this.forceReset&&!t.isMoving()&&(this.reset(),this.forceReset=!1)}playerEvent(t,e){}killSelf(t,e,s=0){this.dying=!0,this.knockDownTimer=0,this.deathTimer=is,this.deathMode=s,this.starSprite.setFrame(Math.random()*4|0,1),this.ghost||(H.getInstance().client.check(this.entityID+114),t.addValueToArray("enemiesKilled",this.entityID,!0)),this.deathPos=this.pos.clone(),e.audio.playSample(e.assets.getSample("kill"),.4)}spinKnockback(t){this.target.x=(t.getPos().x<this.pos.x?1:-1)*3,this.speed.x=this.target.x,this.speed.y=-3}playerCollision(t,e){if(!this.exist||!this.inCamera||this.dying)return!1;let o=this.pos.y+this.center.y-this.hitbox.y-4/4,l=4+Math.abs(this.speed.y),p=t.getHitbox(),d=t.getPos().y+p.y/2,u=t.getPos().x-p.x/2;if((this.canBeSpun||this.knockDownTimer>0)&&t.checkSpinOverlay(this))return this.spinKnockback(t),this.killSelf(t.progress,e,1),!0;if((this.canBeStomped||this.knockDownTimer>0)&&(!t.isSwimming()||t.isSpinning())&&t.getSpeed().y>-.25&&u+p.x>=this.pos.x-this.hitbox.x/2-2&&u<=this.pos.x+this.hitbox.x/2+2&&d>=o&&d<=o+l){if(!t.isSpinning())t.makeJump(-3),(!this.killOnStomp||this.knockOnStomp)&&!t.isDownAttacking()&&e.audio.playSample(e.assets.getSample("hop"),.55);else if(this.canBeSpun||this.knockDownTimer>0)return this.spinKnockback(t),this.killSelf(t.progress,e,1),!0;return this.knockOnStomp&&!t.isDownAttacking()&&!t.isSpinning()?this.knockDown(!1):(this.killOnStomp||t.isDownAttacking())&&this.killSelf(t.progress,e),!0}return this.knockDownTimer<=0&&this.playerEvent(t,e),t.hurtCollision(this.pos.x-this.hitbox.x/2,this.pos.y-this.hitbox.y/2,this.hitbox.x,this.hitbox.y,Math.sign(t.getPos().x-this.pos.x),e)}projectileCollision(t,e,s){return!t.isFriendly()||!this.exist||!this.inCamera||this.dying||!t.doesExist()||t.isDying()?!1:this.overlayObject(t)?(t.destroy(s),this.dieOnProjectile&&this.killSelf(e.progress,s),!0):!1}verticalCollisionEvent(t,e){t==1&&(this.canJump=!0)}makeGhost(){this.ghost=!0}respawnEvent(){}reset(){!this.exist||this.dying||(this.canJump=!1,this.oldCanJump=!1,this.stopMovement(),this.spr.setFrame(0,this.id+2),this.pos=this.startPos.clone(),this.flip=S.None,this.deathTimer=0,this.respawnEvent(),this.hasBaseGravity&&(this.target.y=Wt.BASE_GRAVITY),this.knockDownTimer=0)}respawn(){this.ghost=this.ghost||!this.exist||this.dying,this.dying=!1,this.exist=!0,this.reset()}};Wt.BASE_GRAVITY=2;let v=Wt;class wi extends v{constructor(t,e,s){super(t,e,0,s,!0),this.center=new c(0,3),this.hitbox=new c(8,8),this.knockDownYOffset=5,this.respawnEvent()}respawnEvent(){this.spr.setFrame(Math.random()*4|0,this.spr.getRow())}updateAI(t){this.spr.animate(this.spr.getRow(),0,3,8,t.step)}playerEvent(t,e){this.flip=t.getPos().x<this.pos.x?S.None:S.Horizontal}}class yi extends v{constructor(t,e,s){super(t,e,1,s,!0),this.center=new c(0,3),this.hitbox=new c(8,10),this.knockDownYOffset=5,this.canBeStomped=!1,this.canBeSpun=!1}updateAI(t){this.spr.animate(this.spr.getRow(),0,3,this.spr.getColumn()==0?60:12,t.step)}playerEvent(t,e){this.flip=t.getPos().x<this.pos.x?S.None:S.Horizontal}}class Es extends v{constructor(t,e,s){super(t,e+1,2,s,!0),this.spr.setFrame(0,this.spr.getRow()),this.knockOnStomp=!0,this.collisionBox.x=4,this.center=new c(0,3),this.hitbox=new c(10,8),this.knockDownYOffset=4,this.baseSpeed=0,this.animSpeed=6,this.respawnEvent()}respawnEvent(){this.baseSpeed=this.dir*.2,this.dir=-1+2*(Math.floor(this.startPos.x/16)%2)}updateAI(t){this.spr.animate(this.spr.getRow(),0,3,this.animSpeed,t.step),this.oldCanJump&&!this.canJump&&(this.pos.x-=this.speed.x*t.step,this.baseSpeed*=-1),this.target.x=this.baseSpeed,this.speed.x=this.target.x,this.flip=this.baseSpeed>0?S.Horizontal:S.None}wallCollisionEvent(t,e){this.dir=-t,this.baseSpeed=Math.abs(this.baseSpeed)*this.dir,this.target.x=this.baseSpeed,this.speed.x=this.target.x}}class Ss extends v{constructor(t,e,s){super(t,e+1,3,s,!0),this.center=new c(0,3),this.hitbox=new c(8,8),this.knockDownYOffset=5,this.jumpTimer=0,this.jumpInterval=30,this.jumpHeight=-1.75,this.moveSpeed=.5,this.respawnEvent(),this.friction.y=.1}respawnEvent(){let t=this.startPos.x;this.jumpTimer=this.jumpInterval+(t/16|0)%2*this.jumpInterval/2,this.dir=-1+2*(Math.floor(this.startPos.x/16)%2)}updateAI(t){let s=0;this.canJump?(this.spr.setFrame(0,this.spr.getRow()),this.target.x=0,(this.jumpTimer-=t.step)<=0&&(this.speed.y=this.jumpHeight,this.jumpTimer=this.jumpInterval,this.speed.x=this.dir*this.moveSpeed,this.target.x=this.speed.x,t.audio.playSample(t.assets.getSample("enemyJump"),.5))):(this.speed.y<-.5?s=1:this.speed.y>.5&&(s=2),this.spr.setFrame(s,this.spr.getRow()),this.flip=this.speed.x<0?S.None:S.Horizontal)}wallCollisionEvent(t,e){this.canJump||(this.dir=-t,this.speed.x=this.dir*this.moveSpeed,this.target.x=this.speed.x)}}class Ei extends Es{constructor(t,e,s){super(t,e,s),this.canBeStomped=!1,this.canBeSpun=!1,this.id=4,this.spr.setFrame(0,this.id+2),this.center=new c(0,3),this.hitbox=new c(10,10),this.animSpeed=5}respawnEvent(){this.baseSpeed=this.dir*.3,this.dir=-1+2*(Math.floor(this.startPos.x/16)%2)}}class xs extends v{constructor(t,e,s,i){super(t,e,s,i,!1),this.canBeKnockedDown=!1,this.wave=new c,this.waveSpeed=new c(0,0),this.amplitude=new c(0,0)}updateWave(t){this.wave.x+=this.waveSpeed.x*t.step,this.wave.x%=Math.PI*2,this.wave.y+=this.waveSpeed.y*t.step,this.wave.y%=Math.PI*2,this.pos.x=this.startPos.x+Math.sin(this.wave.x)*this.amplitude.x,this.pos.y=this.startPos.y+Math.sin(this.wave.y)*this.amplitude.y}}class Si extends xs{constructor(t,e,s){super(t,e,5,s),this.center=new c(0,0),this.hitbox=new c(8,8),this.waveSpeed=new c(.05,.025),this.amplitude=new c(4,16),this.respawnEvent()}respawnEvent(){this.wave.zeros(),this.spr.setFrame(Math.random()*4|0,this.spr.getRow())}updateAI(t){this.updateWave(t),this.spr.animate(this.spr.getRow(),0,3,6,t.step)}playerEvent(t,e){this.flip=t.getPos().x<this.pos.x?S.None:S.Horizontal}}class xi extends xs{constructor(t,e,s){super(t,e,6,s),this.center=new c(0,0),this.hitbox=new c(10,8),this.waveSpeed=new c(.025,.05),this.amplitude=new c(16,4),this.respawnEvent()}respawnEvent(){this.wave.zeros(),this.spr.setFrame(Math.random()*4|0,this.spr.getRow())}updateAI(t){this.updateWave(t),this.spr.animate(this.spr.getRow(),0,3,6,t.step)}}const _t=class _t extends v{constructor(t,e,s){super(t,e+1,7,s,!0),this.center=new c(0,3),this.hitbox=new c(8,8),this.knockDownYOffset=1,this.friction.y=.1,this.jumpTimer=0,this.respawnEvent()}respawnEvent(){let t=this.startPos.x;this.jumpTimer=_t.JUMP_TIME+(t/16|0)%2*_t.JUMP_TIME/2}updateAI(t){let i=0;this.canJump?(this.spr.setFrame(0,this.spr.getRow()),(this.jumpTimer-=t.step)<=0&&(this.speed.y=-2.5,this.jumpTimer=_t.JUMP_TIME,t.audio.playSample(t.assets.getSample("enemyJump"),.5))):(this.speed.y<-.5?i=1:this.speed.y>.5&&(i=2),this.spr.setFrame(i,this.spr.getRow()))}playerEvent(t,e){this.canJump&&(this.flip=t.getPos().x<this.pos.x?S.None:S.Horizontal)}};_t.JUMP_TIME=60;let Oe=_t;class Pi extends v{constructor(t,e,s){super(t,e-1,8,s,!1),this.center=new c(0,-1),this.collisionBox.y=16,this.hitbox=new c(10,10),this.canBeKnockedDown=!1,this.killOnStomp=!1,this.dieOnProjectile=!1,this.phase=0,this.shakeTimer=0,this.friction.y=.25,this.respawnEvent()}respawnEvent(){this.phase=0,this.shakeTimer=0,this.spr.setFrame(0,this.spr.getRow())}updateAI(t){this.phase==2?(this.shakeTimer-=t.step)<=0&&(this.phase=3,this.speed.y=-1,this.target.y=-1,this.spr.setFrame(2,this.spr.getRow())):this.phase==3&&this.pos.y<=this.startPos.y+2&&(this.pos.y=this.startPos.y,this.stopMovement(),this.phase=0,this.spr.setFrame(0,this.spr.getRow()))}playerEvent(t,e){let h=t.getPos();this.phase>0||h.y<this.pos.y||Math.abs(h.x-this.pos.x)>32||(this.phase=1,this.target.y=8,this.spr.setFrame(1,this.spr.getRow()))}verticalCollisionEvent(t,e){t!=1||this.phase!=1||(this.phase=2,this.shakeTimer=60,e.shake(60,1),e.audio.playSample(e.assets.getSample("shake"),.5))}}const gt=class gt extends v{constructor(t,e,s){super(t,e,9,s,!0),this.center=new c(0,0),this.hitbox=new c(8,8),this.canBeKnockedDown=!1,this.canBeSpun=!1,this.canBeStomped=!1,this.angle=0,this.offCameraRadius=gt.RADIUS*2,this.disableCollisions=!0,this.respawnEvent()}computePosition(){this.pos.x=this.startPos.x+Math.round(Math.cos(this.angle)*gt.RADIUS*this.dir),this.pos.y=this.startPos.y+Math.round(Math.sin(this.angle)*gt.RADIUS)}respawnEvent(){this.angle=this.startPos.y%360/360*(Math.PI*2),this.dir=(this.startPos.x/16|0)%2==0?1:-1,this.computePosition()}updateAI(t){this.angle=(this.angle+.05*t.step)%(Math.PI*2),this.computePosition();let i=this.dir<0?0:2;this.spr.animate(this.spr.getRow(),i,i+1,8,t.step)}preDraw(t){let s=gt.RADIUS/3,i=t.assets.getBitmap("enemies"),h=0,a,o;for(let l=0;l<3;++l)a=this.startPos.x+Math.round(Math.cos(this.angle)*this.dir*h),o=this.startPos.y+Math.round(Math.sin(this.angle)*h),t.drawSpriteFrame(this.spr,i,4,this.spr.getRow(),a-8,o-8),h+=s}};gt.RADIUS=24;let Be=gt;class Ti extends v{constructor(t,e,s){super(t,e+1,10,s,!1),this.spr.setFrame(0,this.spr.getRow()),this.canBeKnockedDown=!1,this.collisionBox.y=2,this.center=new c(0,0),this.hitbox=new c(10,8),this.baseSpeed=0,this.wave=0,this.friction.y=.05,this.respawnEvent()}respawnEvent(){this.baseSpeed=this.dir*.2,this.wave=0,this.dir=-1+2*(Math.floor(this.startPos.x/16)%2)}updateAI(t){this.oldCanJump&&!this.canJump&&(this.pos.x-=this.speed.x*t.step,this.baseSpeed*=-1),this.target.x=this.baseSpeed,this.speed.x=this.target.x,this.wave=(this.wave+.1*t.step)%(Math.PI*2),this.target.y=Math.sin(this.wave)*.25;let h=0;this.speed.y<-.075?h=2:this.speed.y>.075&&(h=1),this.spr.setFrame(h,this.spr.getRow()),this.flip=this.baseSpeed>0?S.Horizontal:S.None}wallCollisionEvent(t,e){this.dir=-t,this.baseSpeed=Math.abs(this.baseSpeed)*this.dir,this.target.x=this.baseSpeed,this.speed.x=this.target.x}}const Vt=class Vt extends v{constructor(t,e,s){super(t,e,11,s,!1),this.center=new c(0,0),this.hitbox=new c(10,10),this.canBeKnockedDown=!1,this.waitTime=0,this.animationPhase=0,this.direction=new c,this.respawnEvent()}respawnEvent(){this.waitTime=Vt.WAIT_TIME,this.animationPhase=0,this.spr.setFrame(0,this.spr.getRow())}shootBullet(t){let s=c.scalarMultiply(this.direction,1.5);this.projectileCb(this.pos.x,this.pos.y,s.x,s.y,!1,1,!1),t.audio.playSample(t.assets.getSample("shoot"),.4)}updateAI(t){this.animationPhase==0?(this.waitTime-=t.step)<=0&&(this.shootBullet(t),this.animationPhase=1):this.animationPhase==1?(this.spr.animate(this.spr.getRow(),1,4,this.spr.getColumn()==3?30:8,t.step),this.spr.getColumn()==4&&(this.animationPhase=2,this.spr.setFrame(3,this.spr.getRow()))):this.animationPhase==2&&(this.spr.animate(this.spr.getRow(),3,0,8,t.step),this.spr.getColumn()==0&&(this.animationPhase=0,this.waitTime=Vt.WAIT_TIME))}playerEvent(t,e){this.direction=c.direction(this.pos,t.getPos())}};Vt.WAIT_TIME=60;let Fe=Vt;const zt=class zt extends v{constructor(t,e,s){super(t,e,12,s,!1),this.center=new c(0,0),this.hitbox=new c(10,8),this.canBeKnockedDown=!1,this.waitTime=0,this.mouthOpen=!1,this.dir=1,this.respawnEvent()}respawnEvent(){this.waitTime=zt.WAIT_TIME,this.mouthOpen=!1,this.spr.setFrame(0,this.spr.getRow()),this.flip=this.dir<0?S.Horizontal:S.None}shootBullet(t){this.projectileCb(this.pos.x+this.dir*4,this.pos.y+2,2*this.dir,0,!1,1,!1),t.audio.playSample(t.assets.getSample("shoot"),.4)}updateAI(t){this.mouthOpen?(this.spr.animate(this.spr.getRow(),1,0,30,t.step),this.spr.getColumn()==0&&(this.mouthOpen=!1,this.waitTime=zt.WAIT_TIME)):(this.waitTime-=t.step)<=0&&(this.shootBullet(t),this.mouthOpen=!0,this.spr.setFrame(1,this.spr.getRow()))}};zt.WAIT_TIME=60;let fe=zt;class Mi extends fe{constructor(t,e,s){super(t,e,s),this.dir=-1,this.flip=S.Horizontal}}class Ai extends Ss{constructor(t,e,s){super(t,e,s),this.id=13,this.spr.setFrame(0,this.id+2),this.knockDownYOffset=4,this.jumpInterval=20,this.jumpHeight=-2,this.moveSpeed=.5,this.canBeStomped=!1,this.canBeSpun=!1,this.respawnEvent()}}class bi extends v{constructor(t,e,s){super(t,e+1,14,s,!0),this.spr.setFrame(0,this.spr.getRow()),this.collisionBox.x=4,this.center=new c(0,3),this.hitbox=new c(8,10),this.knockDownYOffset=4,this.baseSpeed=0,this.shootTimer=0,this.shootWait=0,this.respawnEvent()}respawnEvent(){this.shootTimer=0,this.shootWait=0,this.baseSpeed=this.dir*.25}shootBullet(t){for(let i=-1;i<=1;i+=2)this.projectileCb(this.pos.x,this.pos.y-2,.75*i,-2.5,!0,1,!1);t.audio.playSample(t.assets.getSample("shoot"),.4)}updateAI(t){if(this.shootWait>0){this.shootWait-=t.step;return}if((this.shootTimer+=t.step)>=120){this.shootTimer=0,this.shootWait=30,this.target.x=0,this.speed.x=0,this.spr.setFrame(4,this.spr.getRow()),this.shootBullet(t);return}this.spr.animate(this.spr.getRow(),0,3,7,t.step),this.oldCanJump&&!this.canJump&&(this.pos.x-=this.speed.x*t.step,this.baseSpeed*=-1),this.target.x=this.baseSpeed,this.speed.x=this.target.x}wallCollisionEvent(t,e){this.dir=-t,this.baseSpeed=Math.abs(this.baseSpeed)*this.dir,this.target.x=this.baseSpeed,this.speed.x=this.target.x}}const hs=[wi,yi,Es,Ss,Ei,Si,xi,Oe,Pi,Be,Ti,Fe,fe,Mi,Ai,bi],Ii=r=>hs[ut(r,0,hs.length-1)];class _i extends mt{constructor(t,e,s){super(t,e,!0),this.spr=new A(16,16),this.hitbox=new c(12,8),this.activated=!1,this.message=s}interactionEvent(t,e,s){if(this.activated)return;let h=s.localization.findValue(["lever"]);h!=null&&(this.message.addMessages(h),this.message.activate(60),s.shake(60,2),this.enable(),t.setUsePose(),H.getInstance().client().check(14),s.audio.playSample(s.assets.getSample("lever"),.5))}draw(t){let e=t.assets.getBitmap("lever");this.inCamera&&t.drawSprite(this.spr,e,this.pos.x-this.spr.width/2,this.pos.y-this.spr.height/2)}enable(){this.activated=!0,this.canInteract=!1,this.spr.setFrame(1,0)}}class ki extends mt{constructor(t,e,s,i){super(t,e,!0),this.spr=new A(16,16),this.flip=S.None,this.hitbox=new c(12,8),this.id=s,this.message=i}updateLogic(t){this.spr.animate(0,0,3,10,t.step)}playerEvent(t,e){this.flip=t.getPos().x<this.pos.x?S.Horizontal:S.None}interactionEvent(t,e,s){let i=s.localization.findValue(["npc",String(this.id)]);i!=null&&(this.message.addMessages(i),this.message.activate(),s.audio.playSample(s.assets.getSample("select"),.5))}draw(t){let e=t.assets.getBitmap("npc");this.inCamera&&t.drawSprite(this.spr,e,this.pos.x-this.spr.width/2,this.pos.y-this.spr.height/2+1,this.flip)}}class Ci extends je{constructor(){super(0,0,!1),this.isFriendly=()=>this.friendly,this.id=0,this.friendly=!1,this.spr=new A(16,16),this.hitbox=new c(10,10),this.collisionBox=new c(2,2),this.friction=new c(.1,.1),this.takeCameraBorderCollision=!1,this.ignoreFenceCollisions=!0}spawn(t,e,s,i,h,a,o=!0){this.pos=new c(t,e),this.speed=new c(s,i),this.target.x=this.speed.x,this.target.y=h?2:this.speed.y,this.friendly=o,this.spr.setFrame(a*2,0),this.id=a,this.exist=!0,this.dying=!1;let p=this.friendly?10:0;this.hitbox.x=p,this.hitbox.y=p}die(t){return this.spr.animate(this.id*2+1,0,4,4,t.step),this.spr.getColumn()==4}destroy(t){this.dying=!0,this.spr.setFrame(0,1),this.stopMovement(),t.audio.playSample(t.assets.getSample("hit"),.6)}outsideCameraEvent(){this.exist=!1,this.dying=!1}preMovementEvent(t){this.id==1&&this.spr.animate(2,0,2,4,t.step)}draw(t){if(!this.exist)return;let e=Math.round(this.pos.x-this.spr.width/2),s=Math.round(this.pos.y-this.spr.height/2);t.drawSprite(this.spr,t.assets.getBitmap("projectile"),e,s)}wallCollisionEvent(t,e){this.destroy(e)}verticalCollisionEvent(t,e){this.destroy(e)}breakCollision(t,e,s,i,h,a){return!this.exist||this.dying||h==0?!1:W(this.pos,this.center,new c(8,8),t,e,s,i)?(this.destroy(a),!0):!1}}class Di extends Me{constructor(t,e){super(t,e,!0),this.down=!1,this.spr=new A(16,16),this.center=new c(0,-6),this.hitbox=new c(8,4)}updateLogic(t){}playerCollision(t,e,s){return this.down||!this.inCamera||t.getSpeed().y<=.1?!1:t.overlayObject(this)?(this.down=!0,this.spr.setFrame(1,0),t.makeJump(-3),e.toggleSpecialBlocks(),t.progress.setBooleanProperty("switchState",!t.progress.getBooleanProperty("switchState")),s.audio.playSample(s.assets.getSample("toggle"),.5),!0):!1}draw(t){this.inCamera&&t.drawSprite(this.spr,t.assets.getBitmap("switch"),this.pos.x-8,this.pos.y-16)}reset(){this.down=!1,this.spr.setFrame(0,0)}}const De=12,Re=45,Ps=(r,t,e)=>{let s=e.localization.findValue(["saveGame"]);s!=null&&(r.addMessages(s),r.activate(0,!0,i=>{t.save()?r.addMessages(i.localization.findValue(["gameSaved"])):r.addMessages(i.localization.findValue(["gameSaveFailed"])),r.activate()},0))};class Ri extends mt{constructor(t,e,s,i,h){super(t,e,!0),this.spr=new A(16,16),this.activated=!1,this.hitbox=new c(16,8),this.id=s,this.wave=0,this.messageTimer=0,this.message=i,this.saveManager=h}outsideCameraEvent(){this.messageTimer=0}updateLogic(t){this.messageTimer>0&&(this.messageTimer-=t.step),this.activated?this.spr.animate(0,1,5,6,t.step):this.spr.setFrame(0,0),this.wave=(this.wave+.067*t.step)%(Math.PI*2)}playerEvent(t,e){t.getActiveCheckpointReference()!=this&&(this.activated=!1,this.wave=0)}extendedPlayerCollisionEvent(t,e){t.maximizeHealth(),!this.activated&&(this.wave=Math.PI+Math.PI/2,this.messageTimer=De+Re,t.progress.setNumberProperty("checkpoint",this.id),this.activated=!0,t.setActiveCheckpointReference(this),e.audio.playSample(e.assets.getSample("checkpoint"),.5))}interactionEvent(t,e,s){Ps(this.message,this.saveManager,s),s.audio.playSample(s.assets.getSample("select"),.5)}draw(t){let s=t.assets.getBitmap("checkpoint");if(!this.inCamera)return;let i=0;this.activated&&(i=3+Math.round(Math.sin(this.wave)*1)),t.drawSprite(this.spr,s,this.pos.x-this.spr.width/2,this.pos.y-this.spr.height/2+1-i),this.messageTimer>0&&(i=this.pos.y,this.messageTimer>Re?i-=(De-(this.messageTimer-Re))*2:i-=De*2,t.drawBitmapRegion(s,0,16,48,16,this.pos.x-24,i-16))}activate(){this.wave=0,this.activated=!0,this.spr.setFrame(1,0),this.messageTimer=0}}class Ni extends Ve{constructor(t,e,s,i,h){super(t,e,!0),this.id=s,this.hintbox=i,this.message=h.localization.findValue(["hints",String(s)]),this.canInteract=!1,this.spr=new A(16,16)}updateLogic(t){this.exist=!1,this.hintbox.setMessage(this.message),this.hintbox.activate()}}const as=["stars","kills"];class Oi extends mt{constructor(t,e,s,i,h){super(t,e,!0),this.spr=new A(32,32),this.spr.setFrame(s,0),this.hitbox=new c(16,8),this.wave=0,this.broken=!1,this.id=s,this.message=i,this.progress=h,this.itemCount=0}setItemCount(t){this.itemCount=t}interactionEvent(t,e,s){if(this.progress.getNumberProperty(as[this.id])<this.itemCount){s.audio.playSample(s.assets.getSample("select"),.5),this.message.addMessages([s.localization.findValue(["orbFail"])]),this.message.activate();return}t.setUsePose(this.pos.x,!0),s.audio.pauseMusic(),s.audio.playSample(s.assets.getSample("orb"),.6),this.message.addMessages([s.localization.findValue(["orb",String(this.id)])]),this.message.activate(1,!1,i=>{i.audio.resumeMusic()}),s.shake(60,2),s.transition.activate(!0,D.CircleOut,1/60,i=>{this.breakSeal(),this.progress.addValueToArray("orbsDestroyed",this.id,!0),i.transition.activate(!1,D.Fade,1/60,null,[255,255,255],4)},[255,255,255]).setCenter(new c(this.pos.x%e.width,this.pos.y%e.height))}updateLogic(t){this.wave=(this.wave+.067*t.step)%(Math.PI*2)}draw(t){if(!this.inCamera)return;let i=t.assets.getBitmap("orb"),h=this.pos.y-24;this.broken?h+=1:h+=-4+Math.round(Math.sin(this.wave)*3),t.drawSprite(this.spr,i,this.pos.x-this.spr.width/2,h)}postDraw(t){const e=[":","="];if(!this.inCamera||this.broken)return;let i=String(String(this.progress.getNumberProperty(as[this.id],0)))+"/"+String(this.itemCount),h=t.assets.getBitmap("fontBig");t.drawText(h,e[this.id],this.pos.x-i.length*4-8,this.pos.y+-44,-8,0,!0),t.drawText(h,i,this.pos.x,this.pos.y+-44,-8,0,!0)}breakSeal(){this.broken=!0,this.spr.setFrame(this.id,1),this.canInteract=!1}}class Bi extends mt{constructor(t,e,s,i,h){super(t,e,!0),this.spr=new A(32,48),this.spr.setFrame(0,1),this.hitbox=new c(16,8),this.message=s,this.progress=i,this.cb=h}interactionEvent(t,e,s){s.audio.playSample(s.assets.getSample("select"),.5),this.message.addMessages(s.localization.findValue(["portal"])),this.message.activate(0,!0,i=>{i.audio.stopMusic(),i.audio.playSample(i.assets.getSample("teleport"),.4),t.setUsePose(this.pos.x),i.shake(120,4),i.transition.activate(!0,D.CirleIn,1/120,h=>{h.transition.activate(!1,D.Fade,1/60,null,[255,255,255],4),this.cb(h)},[255,255,255]).setCenter(new c(this.pos.x%e.width,(this.pos.y-16)%e.height))})}updateLogic(t){this.spr.animate(1,0,2,6,t.step),this.setInteractionState()}draw(t){if(!this.inCamera)return;let e=t.assets.getBitmap("bigDoor"),s=0;t.drawSprite(this.spr,e,this.pos.x-16,this.pos.y-40);for(let i=0;i<2;++i)s=this.progress.doesValueExistInArray("orbsDestroyed",i)?32:0,t.drawBitmapRegion(e,i*16+s,0,16,48,this.pos.x-16+i*16,this.pos.y-40)}setInteractionState(){this.canInteract=this.progress.doesValueExistInArray("orbsDestroyed",0)&&this.progress.doesValueExistInArray("orbsDestroyed",1)}}class Fi{constructor(t,e){this.dispose=()=>0,this.message=new be(e),e.transition.activate(!1,D.Fade,1/60,null,[255,255,255],8),this.drawEnding=!1,this.message.addMessages(e.localization.findValue(["ending"])),this.message.activate(0,!1,s=>{s.transition.activate(!1,D.Fade,1/120,null,[0,0,0],8),this.drawEnding=!0})}update(t){t.transition.isActive()||this.message.update(t)}redraw(t){t.clear(0,0,0),this.message.draw(t,!1);let e=t.assets.getBitmap("theEnd");this.drawEnding&&t.drawBitmap(e,t.width/2-e.width/2,t.height/2-e.height/2)}}class vi extends mt{constructor(t,e,s){super(t,e,!0),this.spr=new A(32,32),this.spr.setFrame(0,0),this.hitbox=new c(16,8),this.message=s}interactionEvent(t,e,s){s.audio.playSample(s.assets.getSample("select"),.5),t.setUsePose(this.pos.x-4,!0),this.message.addMessages(s.localization.findValue(["preEnding","0"])),this.message.activate(0,!1,i=>{this.canInteract=!1,this.spr.setFrame(1,0),this.message.addMessages(i.localization.findValue(["preEnding","1"])),this.message.activate(0,!1,h=>{t.setSleepPose(),this.message.addMessages(h.localization.findValue(["preEnding","2"])),this.message.activate(0,!1,a=>{a.audio.stopMusic(),a.audio.playSample(a.assets.getSample("asleep"),.55),a.copyCanvasToBuffer(),a.transition.activate(!0,D.HorizontalWavesWithFading,1/210,o=>{o.changeScene(Fi)},[255,255,255],8,new c(80,4))})})})}draw(t){if(!this.inCamera)return;let e=t.assets.getBitmap("giantChest");t.drawSprite(this.spr,e,this.pos.x-this.spr.width/2,this.pos.y-24)}}const Li=(r,t,e,s,i)=>{let h;for(let a of r)if(!(!a.doesExist()||a.isDying())&&(h=a.getPos(),h.x>=t&&h.y>=e&&h.x<=t+s&&h.y<=e+i))return!0;return!1};class rs{constructor(t,e,s,i,h,a,o,l=p=>{}){this.isPlayerInside=()=>this.player.isInside(),this.getPlayerHealth=()=>this.player.getHealth(),this.getPlayerMaxHealth=()=>this.player.maxHealth(),this.hasStarInArea=(p,d,u,m)=>Li(this.stars,p,d,u,m),this.getEnemyCount=()=>this.enemies.length,this.getStarCount=()=>this.stars.length,this.player=null,this.progress=i,this.saveManager=h,this.hintbox=a,this.projectiles=new Array,this.projectileCb=(p,d,u,m,y,P,w)=>{Te(this.projectiles,Ci).spawn(p,d,u,m,y,P,w)},this.switches=new Array,this.weakInteractionTargets=new Array,this.strongInteractionTargets=new Array,this.doors=new Array,this.enemies=new Array,this.orbs=new Array,this.lever=null,this.portal=null,this.stars=new Array,this.chests=new Array,this.checkpoints=new Array,this.hintTriggers=new Array,this.message=s,this.portalCb=l,t.parseObjects(this,o),this.findDoorPairs(),this.mergeDoorsToGeneralArray(),e.focusOnObject(this.player),this.passItemCountToOrbs()}passItemCountToOrbs(){for(let t of this.orbs)t.id==0?t.setItemCount(this.stars.length):t.id==1&&t.setItemCount(this.enemies.length)}findDoorPairs(){for(let t of this.doors)for(let e of this.doors)t!==e&&t.inside!=e.inside&&t.id==e.id&&(t.markPair(e),e.markPair(t))}mergeDoorsToGeneralArray(){for(let t of this.doors)this.strongInteractionTargets.push(t)}createPlayer(t,e,s=!1,i=!1){this.player=new F(t*16+16,e*16+8,this.projectileCb,this.progress,s,i)}addSwitch(t,e){this.switches.push(new Di(t*16+8,e*16+16))}addStar(t,e){let s=new fi(t*16+8,e*16+8,this.stars.length);this.weakInteractionTargets.push(s),this.stars.push(s)}addNPC(t,e,s){this.strongInteractionTargets.push(new ki(t*16+8,e*16+8,s,this.message))}addChest(t,e,s){let i=new mi(t*16+8,e*16+8,s,this.message,this.hintbox);this.strongInteractionTargets.push(i),this.chests.push(i)}addLever(t,e){this.lever=new _i(t*16+8,e*16+8,this.message),this.strongInteractionTargets.push(this.lever)}addDoor(t,e,s,i){this.doors.push(new gi(t*16+8,e*16+8,s,i,this.message))}addSavepoint(t,e,s){let i=new Ri(t*16+8,e*16+8,s,this.message,this.saveManager);this.strongInteractionTargets.push(i),this.checkpoints.push(i)}addOrb(t,e,s){let i=new Oi(t*16+8,e*16+8,s,this.message,this.progress);this.strongInteractionTargets.push(i),this.orbs.push(i)}addPortal(t,e){this.portal=new Bi((t+1)*16,e*16+8,this.message,this.progress,this.portalCb),this.strongInteractionTargets.push(this.portal)}addGiantChest(t,e){this.strongInteractionTargets.push(new vi(t*16,e*16+8,this.message))}addEnemy(t,e,s){let i=new(Ii(s)).prototype.constructor(t*16+8,e*16+8,this.enemies.length);i.setProjectileCallback(this.projectileCb),this.enemies.push(i)}addHintTrigger(t,e,s,i){let h=new Ni(t*16,e*16,s,this.hintbox,i);this.weakInteractionTargets.push(h),this.hintTriggers.push(h)}cameraCheck(t){for(let e of this.switches)e.cameraCheck(t);for(let e of this.weakInteractionTargets)e.cameraCheck(t);for(let e of this.strongInteractionTargets)e.cameraCheck(t);for(let e of this.enemies)e.cameraCheck(t)}resetSwitches(t){for(let e of this.switches)e!==t&&e.reset()}updateInteractionTargets(t,e,s){for(let i of t)i.cameraCheck(e),i.update(s),i.playerCollision(this.player,e,s)}reset(t){this.player.respawn(),t.focusOnObject(this.player);for(let e of this.enemies)e.respawn()}update(t,e,s){if(e.isMoving()){this.cameraCheck(e),this.player.cameraMovement(e,s);return}let i;if(!this.player.doesExist()){i=this.player.getPos(),s.transition.activate(!0,D.CirleIn,1/30,h=>{this.reset(e);let a=this.player.getPos();h.transition.setCenter(new c(a.x%e.width,a.y%e.height)),ge(h,this.isPlayerInside(),this.player.isInFinalArea)}).setCenter(new c(i.x%e.width,i.y%e.height));return}this.player.stageEvent(t,e),this.player.update(s),this.player.cameraEvent(e,t,s),t.objectCollisions(this.player,e,s);for(let h of this.projectiles)h.cameraCheck(e),h.doesExist()&&h.isInCamera()&&(h.update(s),t.objectCollisions(h,e,s),this.player.projectileCollision(h,s));for(let h of this.switches)h.cameraCheck(e),h.update(s),h.playerCollision(this.player,t,s)&&this.resetSwitches(h);this.updateInteractionTargets(this.weakInteractionTargets,e,s),this.updateInteractionTargets(this.strongInteractionTargets,e,s);for(let h of this.enemies)if(h.cameraCheck(e),h.cameraEvent(e),h.update(s),t.objectCollisions(h,e,s),h.playerCollision(this.player,s),h.doesExist()&&!h.isDying()&&h.isInCamera())for(let a of this.projectiles)h.projectileCollision(a,this.player,s)}draw(t){for(let e of this.switches)e.draw(t);for(let e of this.weakInteractionTargets)e.draw(t);for(let e of this.strongInteractionTargets)e.draw(t);for(let e of this.enemies)e.draw(t);this.player.preDraw(t),this.player.draw(t);for(let e of this.projectiles)e.draw(t);for(let e of this.strongInteractionTargets)e.postDraw(t)}checkLoop(t){this.player.checkLoop(t)}reinitializeObjectsByProgress(t){for(let s of this.enemies)this.progress.doesValueExistInArray("enemiesKilled",s.entityID)&&s.makeGhost();for(let s of this.stars)this.progress.doesValueExistInArray("starsCollected",s.entityID)&&s.forceKill();for(let s of this.chests)this.progress.doesValueExistInArray("openChests",s.id)&&s.forceOpen();for(let s of this.doors)this.progress.doesValueExistInArray("doors",s.id)&&s.forceOpen();this.player.maximizeHealth();let e=this.progress.getNumberProperty("checkpoint",-1);if(e>=0){for(let s of this.checkpoints)if(s.id==e){s.activate(),this.player.teleportTo(c.add(s.getPos(),new c(0,1)),!1,!1),this.player.setActiveCheckpointReference(s),t.focusOnObject(this.player);break}for(let s of this.hintTriggers)s.forceKill()}for(let s of this.orbs)this.progress.doesValueExistInArray("orbsDestroyed",s.id)&&s.breakSeal();this.lever!=null&&this.progress.getBooleanProperty("fansEnabled")&&this.lever.enable(),this.portal!=null&&this.portal.setInteractionState()}debugDestroyObjects(){for(let t of this.enemies)t.forceKill();for(let t of this.stars)t.forceKill()}killPlayer(t,e){e==!0&&this.player.resetActiveCheckpointReference(),this.player.startDeath(t)}hasEnemyInArea(t,e,s,i){let h;for(let a of this.enemies)if(!(!a.doesExist()||a.isDying()||a.isGhost())&&(h=a.getPos(),h.x>=t&&h.y>=e&&h.x<=t+s&&h.y<=e+i))return!0;return!1}getDoorConnectionInArea(t,e,s,i){let h,a;for(let o of this.doors)if(h=o.getPos(),a=o.getPairPos(),h.x>=t&&h.y>=e&&h.x<=t+s&&h.y<=e+i)return new He(h.x/16|0,h.y/16|0,a.x/16|0,a.y/16|0);return null}}class Ui{constructor(t){this.progress=t}save(){let t=`{
`+this.progress.dump()+`
}`;try{window.localStorage.setItem("__jn_metroidvania3__save",t)}catch(e){return console.log(e),!1}return!0}load(){let t;try{return t=window.localStorage.getItem("__jn_metroidvania3__save"),t==null?null:JSON.parse(t)}catch(e){console.log(e)}return null}}class Hi extends Me{constructor(){super(0,0,!1),this.pos=new c,this.speed=new c,this.gravity=0,this.spr=new A(16,16)}spawn(t,e,s,i=0,h=0,a=0){this.pos=new c(t,e),this.speed=s.clone(),this.gravity=i,this.spr=new A(16,16),this.spr.setFrame(a,h),this.dying=!1,this.exist=!0,this.inCamera=!0}updateLogic(t){this.speed.y+=this.gravity*t.step,this.speed.y>4&&(this.speed.y=4),this.pos.x+=this.speed.x*t.step,this.pos.y+=this.speed.y*t.step}outsideCameraEvent(){this.exist=!1}draw(t){this.exist&&t.drawSprite(this.spr,t.assets.getBitmap("particles"),Math.round(this.pos.x)-8,Math.round(this.pos.y)-8)}}class ji extends ys{constructor(){super(0,0,!1),this.speedFactor=new c,this.speedAngle=0,this.renderPos=new c,this.friction=new c(.1,.1),this.bottom=0,this.size=2,this.inCamera=!0}spawn(t,e,s,i,h,a){this.pos=new c(t,e),this.renderPos=this.pos.clone(),this.speedFactor=new c(s,i),this.speedAngle=Math.random()*Math.PI*2,this.bottom=h,this.size=a,this.exist=!0}preMovementEvent(t){this.pos.y>this.bottom+2&&(this.exist=!1),this.speedAngle=(this.speedAngle+.05*t.step)%(Math.PI*4),this.target.x=Math.sin(this.speedAngle*.5)*this.speedFactor.x,this.target.y=this.speedFactor.y*.5*(Math.sin(this.speedAngle)+1),this.renderPos=this.pos.clone()}cameraEvent(t){let e=t.getDelta();this.renderPos.x=V(this.pos.x-e.x,t.width),this.renderPos.y=V(this.pos.y-e.y,t.height)}draw(t){if(!this.exist)return;let e=Math.round(this.renderPos.x-this.size/2),s=Math.round(this.renderPos.y-this.size/2);t.fillRect(e,s,this.size,this.size)}}class Gi{constructor(t){this.snowflakes=new Array,this.flakeTimer=0,this.generateInitialFlakes(t)}generateInitialFlakes(t){let s,i;for(let h=0;h<16;++h)s=Math.random()*t.width|0,i=Math.random()*t.height|0,this.generateFlake(t,new c(s,i))}generateFlake(t,e){let o=.25+Math.random()*1.25,l=.25+Math.random()*(1.25-.25),p=e!=null?e.x:Math.random()*t.width|0,d=e!=null?e.y:-2;Te(this.snowflakes,ji).spawn(p,d,l,o,t.height,Math.floor(Math.random()*2+1))}update(t,e){if((this.flakeTimer+=e.step)>=20&&(this.generateFlake(t),this.flakeTimer-=20),t.isMoving())for(let i of this.snowflakes)i.cameraEvent(t);else for(let i of this.snowflakes)i.update(e)}draw(t,e=!1){let i=e?0:255;t.setFillColor(i,i,i,.67);for(let h of this.snowflakes)h.draw(t)}}const Y=1,K=2,X=4,q=8,Wi=[Y,X,q,K,Y|q,K|X,K|Y,X|Y,X|q,K|q,K|Y|X,X|Y|q,K|q|X,K|Y|q,K|Y|X|q];class ns{constructor(t,e,s,i=!1){this.tilemap=s.assets.getTilemap(i?"finalArea":"base"),this.collisionMap=s.assets.getTilemap("collisionMap"),this.width=this.tilemap.width,this.height=this.tilemap.height,this.waterLevel=Number(this.tilemap.getProperty("waterLevel")),this.layers=this.tilemap.cloneLayers(3),this.particles=new Array,this.sprFence=new A(16,16),this.fansEnabled=!1,this.waterPos=0,this.waterWave=0,this.snowflakeGen=new Gi(t),this.progress=e,this.isFinal=i}getTile(t,e,s,i=!1,h=!1){return i&&(e=V(e,this.width)),h&&(s=V(s,this.height)),!i&&(e<0||e>=this.width)||!h&&(s<0||s>=this.height)?0:this.layers[t][s*this.width+e]}setTile(t,e,s,i,h=!1,a=!1){if(h&&(s=V(s,this.width)),a&&(i=V(i,this.height)),!h&&(s<0||s>=this.width)||!a&&(i<0||i>=this.height))return 0;this.layers[e][i*this.width+s]=t}update(t,e,s=!1){for(let o of this.particles)o.update(e),o.cameraCheck(t);this.sprFence.animate(0,0,3,4,e.step),this.fansEnabled=this.progress.getBooleanProperty("fansEnabled"),s||this.snowflakeGen.update(t,e),this.waterPos=(this.waterPos+.25*e.step)%16,this.waterWave=(this.waterWave+.067*e.step)%(Math.PI*2)}drawInsideBackground(t,e){t.clear(0,0,0);let s=t.assets.getBitmap("brickwall"),i=e.getPosition(),h=Math.round(i.x/4)%s.width,a=Math.round(i.y/4)%s.height;for(let o=-2;o<=2;++o)for(let l=-2;l<=2;++l)t.drawBitmap(s,l*s.width-h,o*s.height-a)}drawFinalBackground(t,e){t.clear(255,255,255);let s=t.assets.getBitmap("dreamBackground"),i=e.getPosition(),h=Math.round(i.y/2)%s.height;for(let a=0;a<2;++a)t.drawBitmap(s,0,a*s.height-h)}drawBackground(t,e,s=!1){if(this.isFinal){this.drawFinalBackground(t,e);return}if(s){this.drawInsideBackground(t,e);return}let h=t.assets.getBitmap("forest"),a=e.getPosition(),o=V(Math.round(a.x/16),t.width),l=Math.round(a.y/16);t.drawBitmap(t.assets.getBitmap("sky"),0,0);for(let p=-1;p<=1;++p)t.drawBitmap(h,h.width*p-o,t.height-h.height-l+80)}drawWind(t,e,s,i){let h=t.assets.getBitmap("propeller"),a;for(let o=0;o<i;++o)a=s-o*16,t.drawSpriteFrame(this.sprFence,h,this.sprFence.getColumn(),1,e,a)}drawLayer(t,e,s,i=0,h=0,a=this.width,o=this.height){let l,p,d;for(let u=h;u<o;++u)for(let m=i;m<a;++m)if(l=this.getTile(e,m,u,!0,!1),!(l<=0))switch(--l,l){case 15:this.fansEnabled?(this.drawWind(t,m*16,u*16-8,3),t.drawSprite(this.sprFence,t.assets.getBitmap("propeller"),m*16,u*16)):t.drawSpriteFrame(this.sprFence,t.assets.getBitmap("propeller"),0,0,m*16,u*16);break;case 94:case 95:t.drawSpriteFrame(this.sprFence,t.assets.getBitmap("fence"),this.sprFence.getColumn(),l-94,m*16,u*16);break;default:p=l%16|0,d=l/16|0,t.drawBitmapRegion(s,p*16,d*16,16,16,m*16,u*16);break}}drawWater(t,e,s,i,h){if(s<this.waterLevel||h)return;let o=i.getPosition(),l=t.assets.getBitmap("tileset"),p=(this.waterLevel+1)*16,d=Math.round(1+Math.sin(this.waterWave));if(e<this.waterLevel){for(let m=0;m<2;++m){t.setGlobalAlpha(m==0?.67:1);for(let y=-1;y<(i.width/16|0)+1;++y)t.drawBitmapRegion(l,16-m*16,160,16,16-d,o.x+y*16-Math.round(this.waterPos),this.waterLevel*16+d)}t.setGlobalAlpha()}else p=o.y;let u=o.y+i.height-p;t.setFillColor(0,0,0,.67),t.fillRect(o.x,p,i.width,u)}draw(t,e,s=!1){let i=t.assets.getBitmap("tileset"),h=e.getPosition(),a=Math.floor(h.x/16)-1,o=Math.floor(h.y/16)-1,l=a+Math.floor(t.width/16)+2,p=o+Math.floor(t.height/16)+2;for(let d=0;d<this.layers.length;++d)d==1&&this.drawWater(t,o,p,e,s),this.drawLayer(t,d,i,a,o,l,p);for(let d of this.particles)d.draw(t)}postDraw(t,e=!1){e||this.snowflakeGen.draw(t,this.isFinal)}parseObjects(t,e){let h,a=0;for(let o=0;o<this.height;++o)for(let l=0;l<this.width;++l)if(h=this.tilemap.getTile(3,l,o)-256,!(h<=0))switch(o>0&&(a=this.tilemap.getTile(3,l,o-1)-497),h){case 1:t.createPlayer(l,o,Number(this.tilemap.getProperty("startInside"))==1,this.isFinal);break;case 2:t.addSwitch(l,o);break;case 3:t.addStar(l,o);break;case 4:t.addNPC(l,o,a);break;case 5:t.addChest(l,o,a);break;case 6:t.addLever(l,o);break;case 7:case 8:t.addDoor(l,o,a,h==8);break;case 9:t.addSavepoint(l,o,a);break;case 10:t.addHintTrigger(l,o,a,e);break;case 11:case 12:t.addOrb(l,o,h-11);break;case 13:t.addPortal(l,o);break;case 14:t.addGiantChest(l,o);break;default:h>=17&&h<33&&t.addEnemy(l,o,h-17);break}}spawnParticles(t,e,s,i,h=0,a=!1,o=0){let d,u;for(let m=0;m<s;++m)d=Math.PI*2/s*m+h,u=new c(Math.cos(d)*i,-Math.sin(d)*i+-1.75*i),Te(this.particles,Hi).spawn(t,e,u,.15,o,a?m:Math.random()*4|0)}handleBaseTileCollision(t,e,s,i,h,a){let o=Wi[h],l=!1;return(o&Y)==Y&&(l=t.verticalCollision(s*16,i*16,16,1,a)),(o&q)==q&&t.verticalCollision(s*16,(i+1)*16,16,-1,a),(o&X)==X&&t.wallCollision((s+1)*16,i*16,16,-1,a),(o&K)==K&&t.wallCollision(s*16,i*16,16,1,a),l}boxCollision(t,e,s,i,h,a){t.verticalCollision(e,s,i,1,a),t.verticalCollision(e,s+h,i,-1,a),t.wallCollision(e+i,s,h,-1,a),t.wallCollision(e,s,h,1,a)}removeFences(t){let e=t.getPosition(),s=e.x/t.width|0,i=e.y/t.height|0,h=t.width/16|0,a=t.height/16|0;s*=h,i*=a;let o;for(let l=0;l<3;++l)for(let p=i;p<i+a;++p)for(let d=s;d<s+h;++d)o=this.getTile(l,d,p),(o==95||o==96)&&this.setTile(0,l,d,p)}handleSpecialTileCollision(t,e,s,i,h,a,o){const p=[2,0,2,9,5,0],d=[9,2,0,2,0,5],u=[12,7,12,7,6,16],m=[7,12,8,12,16,6],y=[0,1,0,-1,0,0],P=8,w=14,x=16,z=48,it=8;let J=(16-P)/2,j,G,Ie,_e;switch(h){case 15:t.ladderCollision(s*16+J,i*16+15,P,1,!0,o),t.verticalCollision(s*16,(i+1)*16,16,1,o);break;case 31:t.ladderCollision(s*16+J,i*16+1,P,15,!1,o);break;case 16:case 17:t.breakCollision(s*16+(16-w)/2,i*16,w,16,h-16,o)?(this.setTile(0,e,s,i),this.spawnParticles(s*16+8,i*16+8,h==16?6:4,1.5,h==16?Math.PI/3:Math.PI/4,h==17,h-16),h==17&&this.removeFences(a),o.audio.playSample(o.assets.getSample("break"),.6)):this.handleBaseTileCollision(t,e,s,i,14,o);break;case 18:case 19:case 20:case 21:case 22:case 23:if(h>=21&&t.doesIgnoreFenceCollisions())break;j=s*16+p[h-18],G=i*16+d[h-18],Ie=u[h-18],_e=m[h-18],t.hurtCollision(j,G,Ie,_e,y[h-18],o),this.boxCollision(t,j,G,Ie,_e,o);break;case 24:this.fansEnabled&&t.windCollision(s*16,i*16+it-z,x,z,o);break}}objectCollisions(t,e,s){if(!t.doesExist()||t.isDying()||!t.isInCamera())return;let o=Math.floor(t.getPos().x/16),l=Math.floor(t.getPos().y/16),p,d;for(let P=0;P<this.layers.length;++P)for(let w=l-3;w<=l+3;++w)for(let x=o-3;x<=o+3;++x)p=this.getTile(P,x,w,!0,!1),!(p<=0)&&(d=this.collisionMap.getIndexedTile(0,p-1),!(d<=0)&&(d<=15?this.handleBaseTileCollision(t,P,x,w,d-1,s):this.handleSpecialTileCollision(t,P,x,w,d-1,e,s)));let u=this.waterLevel*16+4,m=16,y=e.getPosition();t.doesTakeCameraBorderCollision()&&(t.wallCollision(y.x,y.y,e.height,-1,s),t.wallCollision(y.x+e.width,y.y,e.height,1,s)),t.waterCollision(0,u,this.width*16,m,!0,s),t.waterCollision(0,u+m,this.width*16,this.height*16-u-m,!1,s),t.verticalCollision(0,4,this.width*16,-1,s,!0)}toggleSpecialBlocks(){let t;for(let e=0;e<3;++e)for(let s=0;s<this.width*this.height;++s)t=this.layers[e][s],t==13?this.layers[e][s]=14:t==14&&(this.layers[e][s]=13)}}const Vi=.4,zi=.8,Ji=.4,ge=(r,t=!1,e=!1)=>{let s="theme",i=Vi;e?(s="final",i=Ji):t&&(s="inside",i=zi),r.audio.fadeInMusic(r.assets.getSample(s),i,1e3)};class ze{constructor(t,e){this.dispose=()=>null,this.message=new be(e),this.progress=N.getInstance(),this.saveManager=new Ui(this.progress),this.hintbox=new di,this.camera=new pi(0,0,160,144),this.stage=new ns(this.camera,this.progress,e),this.objects=new rs(this.stage,this.camera,this.message,this.progress,this.saveManager,this.hintbox,e,h=>this.enterFinalArea(h)),this.worldMap=new ss(this.stage,this.progress,e),this.objects.cameraCheck(this.camera);let s=this.camera.getRealPosition();this.progress.addValueToArray("roomVisited",s.y*Math.floor(this.stage.width/10)+s.x|0,!0),this.sprHeart=new A(16,16);let i=e.localization;this.pauseMenu=new Ae([new B(i.findValue(["pauseMenu","0"]),h=>{this.pauseMenu.deactivate(),h.audio.resumeMusic()}),new B(i.findValue(["pauseMenu","1"]),h=>{this.message.addMessages(h.localization.findValue(["respawnAtStart"])),this.message.activate(0,!0,a=>{a.audio.resumeMusic(),this.objects.killPlayer(a,!0),this.pauseMenu.deactivate()})}),new B(i.findValue(["pauseMenu","2"]),h=>{this.message.addMessages(h.localization.findValue(["respawn"])),this.message.activate(0,!0,a=>{a.audio.resumeMusic(),this.objects.killPlayer(a),this.pauseMenu.deactivate()})}),new B(i.findValue(["pauseMenu","3"]),h=>{this.isFinalArea?(this.message.addMessages([h.localization.findValue(["cannotSave"])]),this.message.activate()):Ps(this.message,this.saveManager,h)}),new B(i.findValue(["pauseMenu","4"]),h=>{this.activateMap(()=>{this.pauseMenu.activate(3)},h)&&(this.pauseMenu.deactivate(),h.audio.resumeMusic())}),new B(i.findValue(["pauseMenu","5"]),h=>{this.message.addMessages(i.findValue(["quitGame"])),this.message.activate(0,!0,a=>{this.pauseMenu.deactivate(),a.transition.activate(!0,D.BoxVertical,1/30,o=>{o.changeScene(Ts)})})})]),t!=null&&Number(t)==1&&this.loadGame(),ge(e,this.objects.isPlayerInside(),this.isFinalArea),this.isFinalArea=!1}debug(){for(let t=0;t<=12;++t)this.progress.addValueToArray("items",t,!0);this.progress.setBooleanProperty("fansEnabled"),this.progress.setBooleanProperty("switchState",!this.progress.getBooleanProperty("switchState")),this.stage.toggleSpecialBlocks(),this.pauseMenu.deactivate(),this.objects.debugDestroyObjects(),this.progress.setNumberProperty("kills",99),this.progress.setNumberProperty("stars",99);for(let t=0;t<99;++t)this.progress.addValueToArray("enemiesKilled",t),this.progress.addValueToArray("starsCollected",t)}enterFinalArea(t){this.isFinalArea=!0,this.stage=new ns(this.camera,this.progress,t,!0),this.objects=new rs(this.stage,this.camera,this.message,this.progress,this.saveManager,this.hintbox,t),this.worldMap=new ss(this.stage,this.progress,t),this.objects.cameraCheck(this.camera),this.objects.reinitializeObjectsByProgress(this.camera),ge(t,this.objects.isPlayerInside(),this.isFinalArea)}loadGame(){let t;try{if(t=this.saveManager.load(),t==null)return}catch(e){console.log(e);return}this.progress.recoverFromJSON(t),this.objects.reinitializeObjectsByProgress(this.camera),H.getInstance().updateReceivedItems(),this.progress.getBooleanProperty("switchState")&&this.stage.toggleSpecialBlocks()}activateMap(t,e){return this.isFinalArea?(this.message.addMessages([e.localization.findValue(["cannotSave"])]),this.message.activate(),!1):(this.worldMap.activate(this.stage,this.objects,this.camera),!0)}updateHeart(t){this.sprHeart.animate(0,0,1,this.sprHeart.getColumn()==0?50:10,t.step)}update(t){if(this.hintbox.update(this.camera,t),t.transition.isActive()){this.camera.wasForcedToMove()&&this.objects.cameraCheck(this.camera);return}if(this.message.isActive()){this.message.update(t);return}if(this.worldMap.isActive()){this.worldMap.update(t);return}if(this.pauseMenu.isActive()){this.pauseMenu.update(t);return}if(t.input.getAction("start")==E.Pressed){t.audio.playSample(t.assets.getSample("pause"),.4),t.audio.pauseMusic(),this.pauseMenu.activate(0);return}if(t.input.getAction("map")==E.Pressed){t.audio.playSample(t.assets.getSample("pause"),.4),this.activateMap(()=>{},t);return}this.updateHeart(t),this.camera.update(t)&&(this.objects.checkLoop(this.stage),this.camera.checkLoop(this.stage)),this.stage.update(this.camera,t,this.objects.isPlayerInside()),this.objects.update(this.stage,this.camera,t)}drawHUD(t,e=!1){let i=t.assets.getBitmap("fontBig"),h=t.assets.getBitmap("hearts"),a=String(String(this.progress.getNumberProperty("stars",0)));e&&(a+="/"+this.objects.getStarCount()),t.drawText(i,":",2,1,0,0),t.drawText(i,";"+a,13,1,-8,0);let o=this.progress.getNumberProperty("kills",0);a=String(o),e&&(a+="/"+this.objects.getEnemyCount());let l=(a.length-1)*8;t.drawText(i,"=",t.width-36-l,1,0,0),t.drawText(i,";"+a,t.width-36+11-l,1,-8,0);let p=this.objects.getPlayerHealth(),d=this.objects.getPlayerMaxHealth(),u=0,m=0;for(let y=0;y<d;++y)m=0,u=16,y<p&&(y==p-1&&(m=this.sprHeart.getColumn()*16),u=0),t.drawBitmapRegion(h,m,u,16,16,-1+y*12,t.height-15)}redraw(t){if(t.moveTo(),t.clear(85,85,85),this.stage.drawBackground(t,this.camera,this.objects.isPlayerInside()),this.camera.use(t),t.applyShake(),this.stage.draw(t,this.camera,this.objects.isPlayerInside()),this.objects.draw(t),t.moveTo(),this.stage.postDraw(t,this.objects.isPlayerInside()),this.pauseMenu.isActive()||this.drawHUD(t),this.hintbox.draw(t),this.worldMap.draw(t),this.pauseMenu.isActive()||this.message.draw(t),this.pauseMenu.isActive()){t.setFillColor(0,0,0,.67),t.fillRect();const e=t.assets.getBitmap("items");let s=0,i=108;const h=N.getInstance();for(let a=0;a<13;a++)h.doesValueExistInArray("items",a)&&t.drawBitmapRegion(e,a*16,0,16,16,s,i),s+=16,a==9&&(s-=92,i=124);h.getBooleanProperty("fansEnabled")&&t.drawBitmapRegion(t.assets.getBitmap("propeller"),0,0,16,16,120,124),this.message.isActive()?this.message.draw(t):this.pauseMenu.draw(t,0,0,0,10,!0),this.drawHUD(t,!0)}}}class Yi{constructor(t,e){this.dispose=()=>!1,this.message=new be(e),this.message.addMessages(e.localization.findValue(["storyIntro"])),this.message.activate(0,!1,s=>{s.transition.activate(!1,D.CirleIn,1/30,null).setCenter(new c(80,72)),s.changeScene(ze)}),e.transition.deactivate()}update(t){t.transition.isActive()||this.message.update(t)}redraw(t){t.clear(0,0,0),this.message.draw(t,!1)}}const Ki="v. 2.0-alpha",Xi=.5,os=60;class Ts{constructor(t,e){this.dispose=()=>this.loadGame,this.phase=t==null?1:0,this.enterTimer=1,this.initialTimer=0,this.loadGame=!1,this.menu=new Ae([new B(e.localization.findValue(["titleMenu","0"]),s=>{this.goToGame(!1,s)}),new B(e.localization.findValue(["titleMenu","1"]),s=>{let i=!0;try{window.localStorage.getItem("__jn_metroidvania3__save")==null&&(i=!1)}catch{i=!1}i?this.goToGame(!0,s):(this.message.addMessages(s.localization.findValue(["loadError"])),this.message.activate())})]),this.menu.activate(0),this.message=new be(e),e.audio.fadeInMusic(e.assets.getSample("title"),Xi,1e3),e.transition.activate(!1,D.Fade,1/30,null,[0,0,0],4)}goToGame(t,e){e.audio.stopMusic(),this.loadGame=t,e.transition.activate(!0,D.CirleIn,1/30,s=>{s.changeScene(t?ze:Yi)}).setCenter(new c(80,72))}update(t){const e=.016666666666666666;if(this.phase==0){(this.initialTimer+=t.step)>=os&&++this.phase;return}if(!t.transition.isActive()){if(this.phase==1){this.enterTimer=(this.enterTimer+e*t.step)%1,(t.input.getAction("start")==E.Pressed||t.input.getAction("select")==E.Pressed)&&(t.audio.playSample(t.assets.getSample("start"),.7),++this.phase);return}if(this.message.isActive()){this.message.update(t);return}this.menu.update(t)}}redraw(t){let i=0;this.phase==0&&(i=1-this.initialTimer/os);let h;t.clear(0,85,170),t.drawBitmap(t.assets.getBitmap("sky"),14,-10),h=Math.round(32*i),t.drawBitmap(t.assets.getBitmap("forest"),0,68+h);let a=t.assets.getBitmap("logo");h=8-Math.round((a.height+8)*i),t.drawBitmap(a,0,h),this.phase!=0&&(this.phase==1?this.enterTimer<.5&&t.drawText(t.assets.getBitmap("fontYellow"),"PRESS ENTER",t.width/2,t.height-32,0,0,!0):this.phase==2&&(this.menu.draw(t,0,36,0,12,!0),this.message.isActive()&&(t.setFillColor(0,0,0,.67),t.fillRect(),this.message.draw(t))),t.drawText(t.assets.getBitmap("font"),"2021 Jani Nyknen",t.width/2,t.height-10,0,0,!0),t.drawText(t.assets.getBitmap("fontYellow"),Ki,1,1,-1,0))}}class qi{constructor(t,e){this.dispose=()=>!1,e.transition.activate(!1,D.Fade,1/30,null,[0,0,0],4),this.phase=0,this.timer=0}update(t){t.transition.isActive()||((this.timer+=t.step)>=60||t.input.anyPressed())&&(t.transition.activate(!0,D.Fade,1/30,s=>{++this.phase==2&&s.changeScene(Ts)},[0,0,0],4),this.timer=0)}redraw(t){t.clear(0,0,0),t.drawBitmapRegion(t.assets.getBitmap("intro"),this.phase*160,0,160,144,0,0)}}const kt=class kt{constructor(t,e){this.dispose=()=>0;const s=qi;this.yesNoMenu=new Ae([new B("YES",i=>{i.audio.toggle(!0),i.audio.setGlobalMusicVolume(kt.INITIAL_MUSIC_VOLUME),i.audio.setGlobalSampleVolume(kt.INITIAL_SAMPLE_VOLUME),i.changeScene(s)}),new B("NO",i=>{i.audio.toggle(!1),i.changeScene(s)})]),this.yesNoMenu.activate(0),this.text=String(e.localization.findValue(["audioIntro"])),this.width=Math.max(...this.text.split(`
`).map(i=>i.length))}update(t){this.yesNoMenu.update(t)}redraw(t){t.clear(0,85,170),t.drawText(t.assets.getBitmap("font"),this.text,t.width/2-this.width*8/2,24,0,2,!1),this.yesNoMenu.draw(t,0,32,0,12)}};kt.INITIAL_SAMPLE_VOLUME=.5,kt.INITIAL_MUSIC_VOLUME=.6;let ve=kt;globalThis.getClient=function(){return H.getInstance()};globalThis.getCoreInstance=function(){return dt.getInstance()};globalThis.getPlayer=function(){return F.getInstance()};window.onload=()=>new dt(160,144).run(ve,"/assets/index.json",r=>{r.input.addAction("fire1","KeyZ",null,2).addAction("fire2","KeyX",null,0).addAction("fire3","KeyC",null,1).addAction("fire4","KeyS",null,3).addAction("select","Space",null,0).addAction("start","Enter",null,9,7).addAction("map","ShiftLeft",null,8,6)},r=>{r.prepareLocalization("localization")});
